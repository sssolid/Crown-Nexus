

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer’s Guide: Logging, Error Handling, Dependency Management, Validation, and Metrics Systems &mdash; Crown Nexus 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=01f34227"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="autoapi/index.html" />
    <link rel="prev" title="Crown Nexus Documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Crown Nexus
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer’s Guide: Logging, Error Handling, Dependency Management, Validation, and Metrics Systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging-system">1. Logging System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#key-features">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-logging">Basic Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#request-context-tracking">Request Context Tracking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance-logging">Performance Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exception-system">2. Exception System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#available-exception-types">Available Exception Types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#resource-exceptions">Resource Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-and-authorization-exceptions">Authentication and Authorization Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#business-logic-exceptions">Business Logic Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validation-exceptions">Validation Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#system-exceptions">System Exceptions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#error-handling-system">3. Error Handling System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#error-reporting">Error Reporting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#utility-functions">Utility Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-service">Error Service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dependency-management-system">4. Dependency Management System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#service-registration">Service Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-services">Getting Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependency-injection">Dependency Injection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#in-service-classes">In Service Classes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#validation-system">5. Validation System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-validations">Basic Validations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pydantic-model-validation">Pydantic Model Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-validations">Database Validations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#composite-validation">Composite Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-validation-service">Using the Validation Service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#metrics-system">6. Metrics System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-usage">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tracking-operations">Tracking Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-timing">Function Timing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration-with-database-operations">Integration with Database Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#middleware-integration">Middleware Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pagination-system">7. Pagination System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pagination-models">Pagination Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-pagination-service">Using the Pagination Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-transformations">Custom Transformations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration-with-metrics">Integration with Metrics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rate-limiting-system">8. Rate Limiting System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rate-limit-models">Rate Limit Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-usage-with-middleware">Basic Usage with Middleware</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-rate-limiting-service">Using the Rate Limiting Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manual-rate-limiting">Manual Rate Limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exception-handling">Exception Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">Integration with Metrics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#common-patterns">9. Common Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api-endpoint-error-handling-with-rate-limiting">API Endpoint Error Handling with Rate Limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#standard-api-endpoint-error-handling">Standard API Endpoint Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rate-limited-service-methods">Rate Limited Service Methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-layer-error-handling-and-logging">Service Layer Error Handling and Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#validation-in-services">Validation in Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#metrics-in-services">Metrics in Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging-best-practices">Logging Best Practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#caching-with-fallback-and-metrics">Caching with Fallback and Metrics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cache-system">10. Cache System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-decorators">Using Decorators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-caching-patterns">Advanced Caching Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cache-tags-for-group-invalidation">Cache Tags for Group Invalidation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">Exception Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">Integration with Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#system-integration">System Integration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#error-handling-integration">Error Handling Integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metrics-integration">Metrics Integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">Dependency Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#available-backends">Available Backends</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Crown Nexus</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Developer’s Guide: Logging, Error Handling, Dependency Management, Validation, and Metrics Systems</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/developer_guide.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developer-s-guide-logging-error-handling-dependency-management-validation-and-metrics-systems">
<h1>Developer’s Guide: Logging, Error Handling, Dependency Management, Validation, and Metrics Systems<a class="headerlink" href="#developer-s-guide-logging-error-handling-dependency-management-validation-and-metrics-systems" title="Link to this heading"></a></h1>
<p>This guide provides a practical overview of the logging, error handling, exception, dependency management, validation, metrics, and rate limiting systems. Use it as a reference when implementing these components in your code.</p>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#1-logging-system"><span class="xref myst">Logging System</span></a></p></li>
<li><p><a class="reference internal" href="#2-exception-system"><span class="xref myst">Exception System</span></a></p></li>
<li><p><a class="reference internal" href="#3-error-handling-system"><span class="xref myst">Error Handling System</span></a></p></li>
<li><p><a class="reference internal" href="#4-dependency-management-system"><span class="xref myst">Dependency Management System</span></a></p></li>
<li><p><a class="reference internal" href="#5-validation-system"><span class="xref myst">Validation System</span></a></p></li>
<li><p><a class="reference internal" href="#6-metrics-system"><span class="xref myst">Metrics System</span></a></p></li>
<li><p><a class="reference internal" href="#7-pagination-system"><span class="xref myst">Pagination System</span></a></p></li>
<li><p><a class="reference internal" href="#8-rate-limiting-system"><span class="xref myst">Rate Limiting System</span></a></p></li>
<li><p><a class="reference internal" href="#9-common-patterns"><span class="xref myst">Common Patterns</span></a></p></li>
<li><p><a class="reference internal" href="#10-cache-system"><span class="xref myst">Cache System</span></a></p></li>
</ol>
</section>
<section id="logging-system">
<h2>1. Logging System<a class="headerlink" href="#logging-system" title="Link to this heading"></a></h2>
<p>The logging system provides structured, context-aware logging throughout the application. It supports both human-readable formatted logs for development and JSON logs for production.</p>
<section id="key-features">
<h3>Key Features<a class="headerlink" href="#key-features" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Structured logging with contextual information</p></li>
<li><p>Request and user ID tracking</p></li>
<li><p>Execution time logging</p></li>
<li><p>Line numbers and file information for easy debugging</p></li>
<li><p>Colorized development logs</p></li>
<li><p>JSON-formatted production logs</p></li>
</ul>
</section>
<section id="basic-logging">
<h3>Basic Logging<a class="headerlink" href="#basic-logging" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>

<span class="c1"># Create a logger for your module</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;app.your.module&quot;</span><span class="p">)</span>

<span class="c1"># Log at different levels</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Debug information with context&quot;</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Operation completed successfully&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Something unexpected happened&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="s2">&quot;connection timeout&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Operation failed&quot;</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="s2">&quot;DB_CONN_ERROR&quot;</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred during processing&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exception</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="request-context-tracking">
<h3>Request Context Tracking<a class="headerlink" href="#request-context-tracking" title="Link to this heading"></a></h3>
<p>Request context is automatically managed by middleware, but you can also use it directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">request_context</span><span class="p">,</span> <span class="n">set_user_id</span><span class="p">,</span> <span class="n">clear_user_id</span>

<span class="c1"># Create a custom context for a set of operations</span>
<span class="k">with</span> <span class="n">request_context</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;manual-operation-123&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing administrative operation&quot;</span><span class="p">)</span>
    <span class="c1"># All logs within this context will include the specified request_id and user_id</span>

<span class="c1"># Set just the user ID</span>
<span class="n">set_user_id</span><span class="p">(</span><span class="s2">&quot;user-456&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User context operation&quot;</span><span class="p">)</span>  <span class="c1"># Will include user_id=user-456</span>

<span class="c1"># Clear when done</span>
<span class="n">clear_user_id</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="performance-logging">
<h3>Performance Logging<a class="headerlink" href="#performance-logging" title="Link to this heading"></a></h3>
<p>Use decorators to automatically log execution time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_execution_time</span><span class="p">,</span> <span class="n">log_execution_time_async</span>

<span class="c1"># For synchronous functions</span>
<span class="nd">@log_execution_time</span><span class="p">()</span>  <span class="c1"># Optional parameters: logger, level</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Processing logic</span>
    <span class="k">return</span> <span class="n">result</span>
    <span class="c1"># Will log start/end times and duration automatically</span>

<span class="c1"># For asynchronous functions</span>
<span class="nd">@log_execution_time_async</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">():</span>
    <span class="c1"># Async processing logic</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h3>
<p>The logging system is configured at application startup automatically. The configuration:</p>
<ul class="simple">
<li><p>Sets appropriate formatters for development vs. production</p></li>
<li><p>Routes logs to console and/or files based on environment</p></li>
<li><p>Configures structlog for structured output</p></li>
</ul>
<p>In development:</p>
<ul class="simple">
<li><p>Colorized, human-readable logs with line numbers</p></li>
<li><p>Contextual information for debugging</p></li>
</ul>
<p>In production:</p>
<ul class="simple">
<li><p>JSON-formatted logs for machine processing</p></li>
<li><p>Complete context for log aggregation systems</p></li>
</ul>
</section>
</section>
<section id="exception-system">
<h2>2. Exception System<a class="headerlink" href="#exception-system" title="Link to this heading"></a></h2>
<p>The exception system provides standardized application exceptions with proper error codes, status codes, and response formatting.</p>
<section id="available-exception-types">
<h3>Available Exception Types<a class="headerlink" href="#available-exception-types" title="Link to this heading"></a></h3>
<section id="resource-exceptions">
<h4>Resource Exceptions<a class="headerlink" href="#resource-exceptions" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResourceNotFoundException</span><span class="p">,</span> <span class="n">ResourceAlreadyExistsException</span>

<span class="c1"># When a resource isn&#39;t found</span>
<span class="k">raise</span> <span class="n">ResourceNotFoundException</span><span class="p">(</span>
    <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
    <span class="n">resource_id</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span>  <span class="c1"># Optional - default message generated if omitted</span>
<span class="p">)</span>

<span class="c1"># When a resource already exists</span>
<span class="k">raise</span> <span class="n">ResourceAlreadyExistsException</span><span class="p">(</span>
    <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
    <span class="n">field</span><span class="o">=</span><span class="s2">&quot;email&quot;</span>  <span class="c1"># Default is &quot;id&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="authentication-and-authorization-exceptions">
<h4>Authentication and Authorization Exceptions<a class="headerlink" href="#authentication-and-authorization-exceptions" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthenticationException</span><span class="p">,</span> <span class="n">PermissionDeniedException</span>

<span class="c1"># Authentication failures</span>
<span class="k">raise</span> <span class="n">AuthenticationException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid credentials&quot;</span><span class="p">,</span>
    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;expired_token&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Permission issues</span>
<span class="k">raise</span> <span class="n">PermissionDeniedException</span><span class="p">(</span>
    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;edit&quot;</span><span class="p">,</span>
    <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;Document&quot;</span><span class="p">,</span>
    <span class="n">permission</span><span class="o">=</span><span class="s2">&quot;documents:write&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="business-logic-exceptions">
<h4>Business Logic Exceptions<a class="headerlink" href="#business-logic-exceptions" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">BusinessException</span><span class="p">,</span> <span class="n">InvalidStateException</span><span class="p">,</span> <span class="n">OperationNotAllowedException</span>

<span class="c1"># General business rule violation</span>
<span class="k">raise</span> <span class="n">BusinessException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Cannot complete order&quot;</span><span class="p">,</span>
    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;insufficient_inventory&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Invalid state transitions</span>
<span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Cannot cancel approved order&quot;</span><span class="p">,</span>
    <span class="n">current_state</span><span class="o">=</span><span class="s2">&quot;approved&quot;</span><span class="p">,</span>
    <span class="n">expected_state</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span>
<span class="p">)</span>

<span class="c1"># Disallowed operations</span>
<span class="k">raise</span> <span class="n">OperationNotAllowedException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Cannot delete system user&quot;</span><span class="p">,</span>
    <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span>
    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;system_account&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="validation-exceptions">
<h4>Validation Exceptions<a class="headerlink" href="#validation-exceptions" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationException</span>

<span class="c1"># Single validation error</span>
<span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Validation failed&quot;</span><span class="p">,</span>
    <span class="n">errors</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid email format&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;value_error.email&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Multiple validation errors</span>
<span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Validation failed&quot;</span><span class="p">,</span>
    <span class="n">errors</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Username must be at least 3 characters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;value_error.length&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid email format&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;value_error.email&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="system-exceptions">
<h4>System Exceptions<a class="headerlink" href="#system-exceptions" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DatabaseException</span><span class="p">,</span>
    <span class="n">NetworkException</span><span class="p">,</span>
    <span class="n">ServiceException</span><span class="p">,</span>
    <span class="n">ConfigurationException</span><span class="p">,</span>
    <span class="n">SecurityException</span><span class="p">,</span>
    <span class="n">RateLimitException</span>
<span class="p">)</span>

<span class="c1"># Database errors</span>
<span class="k">raise</span> <span class="n">DatabaseException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Failed to insert record&quot;</span><span class="p">,</span>
    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;users&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># External service errors</span>
<span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Payment service unavailable&quot;</span><span class="p">,</span>
    <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span>
<span class="p">)</span>

<span class="c1"># Rate limiting</span>
<span class="k">raise</span> <span class="n">RateLimitException</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Too many requests&quot;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="s2">&quot;60&quot;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="error-handling-system">
<h2>3. Error Handling System<a class="headerlink" href="#error-handling-system" title="Link to this heading"></a></h2>
<p>The error handling system provides utilities for reporting errors to various destinations and creating common exception types.</p>
<section id="error-reporting">
<h3>Error Reporting<a class="headerlink" href="#error-reporting" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.error</span><span class="w"> </span><span class="kn">import</span> <span class="n">report_error</span><span class="p">,</span> <span class="n">handle_exception</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.error.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ErrorContext</span>

<span class="c1"># Manual error reporting with context</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">payment_data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Payment processing logic</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">payment_gateway</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">payment_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Create context with relevant information</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ErrorContext</span><span class="p">(</span>
            <span class="n">function</span><span class="o">=</span><span class="s2">&quot;process_payment&quot;</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payment_data&quot;</span><span class="p">:</span> <span class="n">payment_data</span><span class="p">},</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">get_current_request_id</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Report to all registered reporters</span>
        <span class="k">await</span> <span class="n">report_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="c1"># Re-raise to be handled upstream</span>
        <span class="k">raise</span>

<span class="c1"># Simplified error handling</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_user_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Update logic</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Automatically extracts context from current function</span>
        <span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">raise</span>
</pre></div>
</div>
</section>
<section id="utility-functions">
<h3>Utility Functions<a class="headerlink" href="#utility-functions" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.error</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ensure_not_none</span><span class="p">,</span>
    <span class="n">resource_not_found</span><span class="p">,</span>
    <span class="n">resource_already_exists</span><span class="p">,</span>
    <span class="n">validation_error</span><span class="p">,</span>
    <span class="n">permission_denied</span><span class="p">,</span>
    <span class="n">business_logic_error</span>
<span class="p">)</span>

<span class="c1"># Check for null values with automatic exception</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">):</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">ensure_not_none</span><span class="p">(</span>
        <span class="n">product_repository</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">product_id</span><span class="p">),</span>
        <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;Product&quot;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="o">=</span><span class="n">product_id</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">product</span>

<span class="c1"># Create specific exceptions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_user_creation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">existing_user</span> <span class="o">=</span> <span class="n">user_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">existing_user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">resource_already_exists</span><span class="p">(</span>
            <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="n">field</span><span class="o">=</span><span class="s2">&quot;email&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_email_format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">validation_error</span><span class="p">(</span>
            <span class="n">field</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="error-service">
<h3>Error Service<a class="headerlink" href="#error-service" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="c1"># Get the error service through dependency injection</span>
<span class="n">error_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;error_service&quot;</span><span class="p">)</span>

<span class="c1"># Report an error</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_process_failure</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">context_data</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ErrorContext</span><span class="p">(</span>
        <span class="n">function</span><span class="o">=</span><span class="s2">&quot;process_data&quot;</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="n">context_data</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">context_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">await</span> <span class="n">error_service</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

<span class="c1"># Create specific exceptions through the service</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_authorization</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_has_permission</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error_service</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">resource_type</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">permission</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="dependency-management-system">
<h2>4. Dependency Management System<a class="headerlink" href="#dependency-management-system" title="Link to this heading"></a></h2>
<p>The dependency management system handles service registration, initialization, and dependency injection.</p>
<section id="service-registration">
<h3>Service Registration<a class="headerlink" href="#service-registration" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_service</span>

<span class="c1"># Register a service factory function</span>
<span class="nd">@register_service</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_notification_service</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create and return a notification service instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">NotificationService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1"># Register with explicit name</span>
<span class="nd">@register_service</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;email_sender&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_email_service</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create and return an email service instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">EmailService</span><span class="p">(</span>
        <span class="n">smtp_host</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SMTP_HOST</span><span class="p">,</span>
        <span class="n">smtp_port</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SMTP_PORT</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="getting-services">
<h3>Getting Services<a class="headerlink" href="#getting-services" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_dependency</span><span class="p">,</span> <span class="n">get_service</span>

<span class="c1"># In FastAPI endpoints</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/notify&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">notify_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="c1"># Get service with database session</span>
    <span class="n">notification_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;notification_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">notification_service</span><span class="o">.</span><span class="n">send_notification</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;notification sent&quot;</span><span class="p">}</span>

<span class="c1"># Get by class name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.services.user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>
<span class="n">user_service</span> <span class="o">=</span> <span class="n">get_dependency</span><span class="p">(</span><span class="n">UserService</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dependency-injection">
<h3>Dependency Injection<a class="headerlink" href="#dependency-injection" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">inject_dependency</span><span class="p">,</span> <span class="n">with_dependencies</span>

<span class="c1"># Inject a single dependency</span>
<span class="nd">@inject_dependency</span><span class="p">(</span><span class="s2">&quot;audit_service&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_user_action</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">audit_service</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log a user action using the injected audit service.&quot;&quot;&quot;</span>
    <span class="n">audit_service</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

<span class="c1"># Inject multiple dependencies</span>
<span class="nd">@with_dependencies</span><span class="p">(</span><span class="n">notifier</span><span class="o">=</span><span class="s2">&quot;notification_service&quot;</span><span class="p">,</span> <span class="n">audit</span><span class="o">=</span><span class="s2">&quot;audit_service&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">notifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process an order with multiple injected services.&quot;&quot;&quot;</span>
    <span class="c1"># Process order...</span>

    <span class="c1"># Use injected services</span>
    <span class="k">await</span> <span class="n">notifier</span><span class="o">.</span><span class="n">send_notification</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;Order processed&quot;</span><span class="p">)</span>
    <span class="n">audit</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;order_processed&quot;</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="in-service-classes">
<h3>In Service Classes<a class="headerlink" href="#in-service-classes" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="c1"># Get dependencies in constructor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;audit_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;notification_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Business logic</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Use services</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_service</span><span class="o">.</span><span class="n">log_user_update</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">notify_profile_update</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">user</span>
</pre></div>
</div>
</section>
</section>
<section id="validation-system">
<h2>5. Validation System<a class="headerlink" href="#validation-system" title="Link to this heading"></a></h2>
<p>The validation system provides comprehensive tools for validating data throughout the application, ensuring data integrity and consistency.</p>
<section id="id1">
<h3>Key Features<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Validation of various data types (emails, URLs, dates, etc.)</p></li>
<li><p>Pydantic model validation</p></li>
<li><p>Database-specific validations (e.g., uniqueness)</p></li>
<li><p>Composite validation with multiple rules</p></li>
<li><p>Integration with error handling and logging systems</p></li>
<li><p>Extensible validator architecture</p></li>
</ul>
</section>
<section id="basic-validations">
<h3>Basic Validations<a class="headerlink" href="#basic-validations" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">validate_email</span><span class="p">,</span>
    <span class="n">validate_phone</span><span class="p">,</span>
    <span class="n">validate_date</span><span class="p">,</span>
    <span class="n">validate_length</span><span class="p">,</span>
    <span class="n">validate_range</span><span class="p">,</span>
    <span class="n">validate_regex</span><span class="p">,</span>
    <span class="n">validate_required</span><span class="p">,</span>
    <span class="n">validate_url</span><span class="p">,</span>
    <span class="n">validate_uuid</span><span class="p">,</span>
    <span class="n">validate_credit_card</span><span class="p">,</span>
    <span class="n">validate_ip_address</span><span class="p">,</span>
    <span class="n">validate_password_strength</span><span class="p">,</span>
    <span class="n">validate_enum</span>
<span class="p">)</span>

<span class="c1"># Simple validation functions return boolean results</span>
<span class="n">is_valid_email</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
<span class="n">is_valid_phone</span> <span class="o">=</span> <span class="n">validate_phone</span><span class="p">(</span><span class="s2">&quot;+12125551234&quot;</span><span class="p">)</span>
<span class="n">is_valid_url</span> <span class="o">=</span> <span class="n">validate_url</span><span class="p">(</span><span class="s2">&quot;https://example.com&quot;</span><span class="p">)</span>
<span class="n">is_complex_password</span> <span class="o">=</span> <span class="n">validate_password_strength</span><span class="p">(</span>
    <span class="s2">&quot;SecureP@ss123&quot;</span><span class="p">,</span>
    <span class="n">min_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">require_lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">require_uppercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">require_digit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">require_special</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Date validation with range constraints</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
<span class="n">is_valid_date</span> <span class="o">=</span> <span class="n">validate_date</span><span class="p">(</span>
    <span class="s2">&quot;2023-05-15&quot;</span><span class="p">,</span>
    <span class="n">min_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">max_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
    <span class="n">format_str</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="c1"># Enum validation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserRole</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">GUEST</span> <span class="o">=</span> <span class="s2">&quot;guest&quot;</span>

<span class="n">is_valid_role</span> <span class="o">=</span> <span class="n">validate_enum</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">UserRole</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pydantic-model-validation">
<h3>Pydantic Model Validation<a class="headerlink" href="#pydantic-model-validation" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_data</span><span class="p">,</span> <span class="n">validate_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># Define a Pydantic model</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&quot;</span><span class="p">)</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Validate input data against the model</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;Secret123&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span>
    <span class="p">}</span>

    <span class="c1"># Returns a validated model instance or raises ValidationException</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">validate_data</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="n">UserCreate</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid user: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="n">ValidationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation failed: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="database-validations">
<h3>Database Validations<a class="headerlink" href="#database-validations" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_unique</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="c1"># Check if a value is unique in the database</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Check username uniqueness</span>
    <span class="n">is_username_unique</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validate_unique</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="s2">&quot;username&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_username_unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
            <span class="s2">&quot;Validation failed&quot;</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="p">[{</span>
                <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Username &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; is already taken&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unique_error&quot;</span>
            <span class="p">}]</span>
        <span class="p">)</span>

    <span class="c1"># Check email uniqueness</span>
    <span class="n">is_email_unique</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validate_unique</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_email_unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
            <span class="s2">&quot;Validation failed&quot;</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="p">[{</span>
                <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Email &#39;</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&#39; is already registered&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unique_error&quot;</span>
            <span class="p">}]</span>
        <span class="p">)</span>

    <span class="c1"># Proceed with creation</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="composite-validation">
<h3>Composite Validation<a class="headerlink" href="#composite-validation" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_composite</span>

<span class="c1"># Define validation rules for multiple fields</span>
<span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">},</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s2">&quot;require_uppercase&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;require_digit&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Validate data against the rules</span>
<span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;Secret123&quot;</span><span class="p">,</span>
    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span>
<span class="p">}</span>

<span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validate_composite</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field: </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Error: </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-the-validation-service">
<h3>Using the Validation Service<a class="headerlink" href="#using-the-validation-service" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_validation_service</span>

<span class="c1"># In FastAPI endpoints</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span>
    <span class="n">user_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="c1"># Get validation service with database session</span>
    <span class="n">validation_service</span> <span class="o">=</span> <span class="n">get_validation_service</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Validate email</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_service</span><span class="o">.</span><span class="n">validate_email</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
            <span class="s2">&quot;Validation failed&quot;</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="p">[{</span>
                <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid email format&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;value_error.email&quot;</span>
            <span class="p">}]</span>
        <span class="p">)</span>

    <span class="c1"># Check uniqueness</span>
    <span class="n">is_email_unique</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validation_service</span><span class="o">.</span><span class="n">validate_unique</span><span class="p">(</span>
        <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span> <span class="n">User</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_email_unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
            <span class="s2">&quot;Validation failed&quot;</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="p">[{</span>
                <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Email already registered&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unique_error&quot;</span>
            <span class="p">}]</span>
        <span class="p">)</span>

    <span class="c1"># Create user</span>
    <span class="c1"># ...</span>

<span class="c1"># Or through dependency manager</span>
<span class="n">validation_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;validation_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="metrics-system">
<h2>6. Metrics System<a class="headerlink" href="#metrics-system" title="Link to this heading"></a></h2>
<p>The metrics system provides tools for measuring and monitoring application performance and behavior. It supports various metric types and integrates with Prometheus for visualization and alerting.</p>
<section id="id2">
<h3>Key Features<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Multiple metric types (counter, gauge, histogram, summary)</p></li>
<li><p>Automatic tracking of HTTP requests, DB queries, service calls, and cache operations</p></li>
<li><p>Timing decorators for function execution</p></li>
<li><p>Prometheus integration</p></li>
<li><p>Configurable metric collection and reporting</p></li>
</ul>
</section>
<section id="basic-usage">
<h3>Basic Usage<a class="headerlink" href="#basic-usage" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="c1"># Get the metrics service</span>
<span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>

<span class="c1"># Create and use counter metrics</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">create_counter</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;user_registrations_total&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total number of user registrations&quot;</span><span class="p">,</span>
    <span class="n">labelnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Increment counter</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
    <span class="s2">&quot;user_registrations_total&quot;</span><span class="p">,</span>
    <span class="n">amount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;web&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;customer&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Create and use gauge metrics</span>
<span class="n">gauge</span> <span class="o">=</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">create_gauge</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;active_users&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of currently active users&quot;</span><span class="p">,</span>
    <span class="n">labelnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenant&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Set gauge value</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span>
    <span class="s2">&quot;active_users&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tenant&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Create and use histogram metrics</span>
<span class="n">histogram</span> <span class="o">=</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">create_histogram</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;order_processing_seconds&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Time spent processing orders&quot;</span><span class="p">,</span>
    <span class="n">labelnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Observe histogram value</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
    <span class="s2">&quot;order_processing_seconds&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="mf">1.7</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tracking-operations">
<h3>Tracking Operations<a class="headerlink" href="#tracking-operations" title="Link to this heading"></a></h3>
<p>The metrics system provides pre-built trackers for common operations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>

<span class="c1"># Track HTTP request</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">track_request</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/api/users&quot;</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">0.125</span>
<span class="p">)</span>

<span class="c1"># Track database query</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">track_db_query</span><span class="p">(</span>
    <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;SELECT&quot;</span><span class="p">,</span>
    <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">0.087</span>
<span class="p">)</span>

<span class="c1"># Track service call</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">track_service_call</span><span class="p">(</span>
    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;external_api&quot;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;get_weather&quot;</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">0.342</span>
<span class="p">)</span>

<span class="c1"># Track cache operation</span>
<span class="n">metrics_service</span><span class="o">.</span><span class="n">track_cache_operation</span><span class="p">(</span>
    <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;redis&quot;</span><span class="p">,</span>
    <span class="n">hit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;user_profile&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="function-timing">
<h3>Function Timing<a class="headerlink" href="#function-timing" title="Link to this heading"></a></h3>
<p>Measure function performance with decorators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetricType</span>

<span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>

<span class="c1"># Timing synchronous functions</span>
<span class="nd">@metrics_service</span><span class="o">.</span><span class="n">timed_function</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;process_user_data_duration&quot;</span><span class="p">,</span>
    <span class="n">metric_type</span><span class="o">=</span><span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Processing logic</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Timing asynchronous functions with labels</span>
<span class="nd">@metrics_service</span><span class="o">.</span><span class="n">async_timed_function</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fetch_external_data_duration&quot;</span><span class="p">,</span>
    <span class="n">metric_type</span><span class="o">=</span><span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">,</span>
    <span class="n">labels_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">resource_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;resource_type&quot;</span><span class="p">:</span> <span class="n">resource_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_external_data</span><span class="p">(</span><span class="n">resource_id</span><span class="p">):</span>
    <span class="c1"># Async processing logic</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Tracking in-progress operations</span>
<span class="nd">@metrics_service</span><span class="o">.</span><span class="n">async_timed_function</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;long_running_operation_duration&quot;</span><span class="p">,</span>
    <span class="n">track_in_progress_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">in_progress_metric</span><span class="o">=</span><span class="s2">&quot;long_running_operations_in_progress&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">long_running_operation</span><span class="p">():</span>
    <span class="c1"># Long-running operation logic</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="integration-with-database-operations">
<h3>Integration with Database Operations<a class="headerlink" href="#integration-with-database-operations" title="Link to this heading"></a></h3>
<p>Track database operation performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">track_db_select</span><span class="p">,</span> <span class="n">track_db_insert</span>

<span class="c1"># Track SELECT operations</span>
<span class="nd">@track_db_select</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_users_by_role</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">role</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

<span class="c1"># Track INSERT operations</span>
<span class="nd">@track_db_insert</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">order_data</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="o">**</span><span class="n">order_data</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">order</span>
</pre></div>
</div>
</section>
<section id="middleware-integration">
<h3>Middleware Integration<a class="headerlink" href="#middleware-integration" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetricName</span><span class="p">,</span> <span class="n">MetricTag</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MetricsMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
        <span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># Track in-progress requests</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">MetricTag</span><span class="o">.</span><span class="n">METHOD</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="n">MetricTag</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
        <span class="p">}</span>
        <span class="n">metrics_service</span><span class="o">.</span><span class="n">track_in_progress</span><span class="p">(</span><span class="n">MetricName</span><span class="o">.</span><span class="n">HTTP_IN_PROGRESS</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># Track completed request</span>
            <span class="n">metrics_service</span><span class="o">.</span><span class="n">track_request</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Error-Code&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># Track failed request</span>
            <span class="n">metrics_service</span><span class="o">.</span><span class="n">track_request</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span>

            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Ensure we decrement the in-progress counter</span>
            <span class="n">metrics_service</span><span class="o">.</span><span class="n">track_in_progress</span><span class="p">(</span><span class="n">MetricName</span><span class="o">.</span><span class="n">HTTP_IN_PROGRESS</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3>Configuration<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>Configure the metrics system at application startup:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetricsConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="c1"># In app startup</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup</span><span class="p">():</span>
    <span class="n">metrics_config</span> <span class="o">=</span> <span class="n">MetricsConfig</span><span class="p">(</span>
        <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;crown_nexus&quot;</span><span class="p">,</span>
        <span class="n">subsystem</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">,</span>
        <span class="n">default_labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="o">.</span><span class="n">value</span><span class="p">},</span>
        <span class="n">enable_prometheus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">endpoint_port</span><span class="o">=</span><span class="mi">9090</span>
    <span class="p">)</span>

    <span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">metrics_config</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="pagination-system">
<h2>7. Pagination System<a class="headerlink" href="#pagination-system" title="Link to this heading"></a></h2>
<p>The pagination system provides standardized, flexible pagination for database queries, supporting both offset-based and cursor-based pagination approaches.</p>
<section id="id4">
<h3>Key Features<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Support for both offset-based and cursor-based pagination</p></li>
<li><p>Integration with SQLAlchemy for efficient database queries</p></li>
<li><p>Automatic counting and metadata calculation</p></li>
<li><p>Customizable sort fields and directions</p></li>
<li><p>Data transformation capabilities</p></li>
<li><p>Type-safe interfaces with Pydantic models</p></li>
<li><p>Comprehensive error handling</p></li>
<li><p>Metrics tracking</p></li>
<li><p>Easy integration through dependency injection</p></li>
</ul>
</section>
<section id="pagination-models">
<h3>Pagination Models<a class="headerlink" href="#pagination-models" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.pagination</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">OffsetPaginationParams</span><span class="p">,</span>
    <span class="n">CursorPaginationParams</span><span class="p">,</span>
    <span class="n">SortDirection</span><span class="p">,</span>
    <span class="n">SortField</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="c1"># Create offset-based pagination parameters</span>
<span class="n">offset_params</span> <span class="o">=</span> <span class="n">OffsetPaginationParams</span><span class="p">(</span>
    <span class="n">page</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">page_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">sort</span><span class="o">=</span><span class="p">[</span>
        <span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">SortDirection</span><span class="o">.</span><span class="n">DESC</span><span class="p">),</span>
        <span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">SortDirection</span><span class="o">.</span><span class="n">ASC</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Create cursor-based pagination parameters</span>
<span class="n">cursor_params</span> <span class="o">=</span> <span class="n">CursorPaginationParams</span><span class="p">(</span>
    <span class="n">cursor</span><span class="o">=</span><span class="s2">&quot;eyJpZCI6IjEyMyIsImNyZWF0ZWRfYXQiOiIyMDIzLTA1LTE1VDEyOjMwOjAwIn0=&quot;</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">sort</span><span class="o">=</span><span class="p">[</span>
        <span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">SortDirection</span><span class="o">.</span><span class="n">DESC</span><span class="p">),</span>
        <span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">SortDirection</span><span class="o">.</span><span class="n">ASC</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Define a Pydantic model for the response</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>Basic Usage<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.pagination</span><span class="w"> </span><span class="kn">import</span> <span class="n">paginate_with_offset</span><span class="p">,</span> <span class="n">paginate_with_cursor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>

<span class="c1"># In a service or repository</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_users_paginated</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">OffsetPaginationParams</span><span class="p">):</span>
    <span class="c1"># Create a query</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Apply pagination</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">paginate_with_offset</span><span class="p">(</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="n">model_class</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Converting pagination result to a response format</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_response</span><span class="p">(</span><span class="n">pagination_result</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">page</span><span class="p">,</span>
            <span class="s2">&quot;page_size&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">page_size</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span>
            <span class="s2">&quot;has_next&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">,</span>
            <span class="s2">&quot;has_prev&quot;</span><span class="p">:</span> <span class="n">pagination_result</span><span class="o">.</span><span class="n">has_prev</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="using-the-pagination-service">
<h3>Using the Pagination Service<a class="headerlink" href="#using-the-pagination-service" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.pagination</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_pagination_service</span>

<span class="c1"># In FastAPI endpoints</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">(</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">SortDirection</span> <span class="o">=</span> <span class="n">SortDirection</span><span class="o">.</span><span class="n">DESC</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="c1"># Get pagination service with database session</span>
    <span class="n">pagination_service</span> <span class="o">=</span> <span class="n">get_pagination_service</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Create pagination parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">OffsetPaginationParams</span><span class="p">(</span>
        <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
        <span class="n">page_size</span><span class="o">=</span><span class="n">page_size</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">sort_order</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="c1"># Create query</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Apply pagination</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pagination_service</span><span class="o">.</span><span class="n">paginate_with_offset</span><span class="p">(</span>
        <span class="n">model_class</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">page</span><span class="p">,</span>
            <span class="s2">&quot;page_size&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">page_size</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span>
            <span class="s2">&quot;has_next&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">has_next</span><span class="p">,</span>
            <span class="s2">&quot;has_prev&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">has_prev</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1"># Cursor-based pagination example</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/cursor&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_users_with_cursor</span><span class="p">(</span>
    <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">SortDirection</span> <span class="o">=</span> <span class="n">SortDirection</span><span class="o">.</span><span class="n">DESC</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">pagination_service</span> <span class="o">=</span> <span class="n">get_pagination_service</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">CursorPaginationParams</span><span class="p">(</span>
        <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">sort_order</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pagination_service</span><span class="o">.</span><span class="n">paginate_with_cursor</span><span class="p">(</span>
        <span class="n">model_class</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">UserResponse</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;has_next&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">has_next</span><span class="p">,</span>
            <span class="s2">&quot;has_prev&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">has_prev</span><span class="p">,</span>
            <span class="s2">&quot;next_cursor&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">next_cursor</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="error-handling">
<h3>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.pagination.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PaginationException</span><span class="p">,</span>
    <span class="n">InvalidPaginationParamsException</span><span class="p">,</span>
    <span class="n">InvalidCursorException</span><span class="p">,</span>
    <span class="n">InvalidSortFieldException</span>
<span class="p">)</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_products</span><span class="p">(</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">SortDirection</span> <span class="o">=</span> <span class="n">SortDirection</span><span class="o">.</span><span class="n">ASC</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pagination_service</span> <span class="o">=</span> <span class="n">get_pagination_service</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">OffsetPaginationParams</span><span class="p">(</span>
            <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
            <span class="n">page_size</span><span class="o">=</span><span class="n">page_size</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">sort_order</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Product</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pagination_service</span><span class="o">.</span><span class="n">paginate_with_offset</span><span class="p">(</span>
            <span class="n">model_class</span><span class="o">=</span><span class="n">Product</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ProductResponse</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">to_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidSortFieldException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Handle invalid sort field</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid sort field: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidPaginationParamsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Handle invalid pagination parameters</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid pagination parameters: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">PaginationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Handle other pagination exceptions</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-transformations">
<h3>Custom Transformations<a class="headerlink" href="#custom-transformations" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.pagination</span><span class="w"> </span><span class="kn">import</span> <span class="n">paginate_with_offset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_products_with_categories</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="c1"># Join with categories</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">Category</span><span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">Product</span><span class="o">.</span><span class="n">category_id</span> <span class="o">==</span> <span class="n">Category</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Product</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Define a custom transform function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_product</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="n">product</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
            <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">category</span><span class="o">.</span><span class="n">name</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="c1"># Apply pagination with custom transformation</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">paginate_with_offset</span><span class="p">(</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="n">model_class</span><span class="o">=</span><span class="n">Product</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">transform_func</span><span class="o">=</span><span class="n">transform_product</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="integration-with-metrics">
<h3>Integration with Metrics<a class="headerlink" href="#integration-with-metrics" title="Link to this heading"></a></h3>
<p>The pagination system automatically integrates with the metrics system to track performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># These metrics are recorded automatically when using the pagination service</span>
<span class="c1"># - pagination_duration_seconds (histogram)</span>
<span class="c1"># - pagination_operations_total (counter)</span>

<span class="c1"># Manual tracking for custom pagination implementations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">custom_pagination</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Custom pagination logic</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">metrics_service</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
            <span class="s2">&quot;custom_pagination_duration_seconds&quot;</span><span class="p">,</span>
            <span class="n">duration</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="rate-limiting-system">
<h2>8. Rate Limiting System<a class="headerlink" href="#rate-limiting-system" title="Link to this heading"></a></h2>
<p>The rate limiting system provides mechanisms to protect the application from excessive use by limiting the number of requests a client can make within a specified time window.</p>
<section id="id6">
<h3>Key Features<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Support for different rate limit strategies (IP-based, user-based, combined)</p></li>
<li><p>Multiple configurable rate limit rules</p></li>
<li><p>Both Redis-backed and in-memory implementations</p></li>
<li><p>Path-specific rules and path exclusions</p></li>
<li><p>Rate limit headers in responses</p></li>
<li><p>Metrics tracking</p></li>
<li><p>Integration with the exception system</p></li>
</ul>
</section>
<section id="rate-limit-models">
<h3>Rate Limit Models<a class="headerlink" href="#rate-limit-models" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitRule</span><span class="p">,</span> <span class="n">RateLimitStrategy</span>

<span class="c1"># Create a basic rate limit rule</span>
<span class="n">basic_rule</span> <span class="o">=</span> <span class="n">RateLimitRule</span><span class="p">(</span>
    <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="n">RateLimitStrategy</span><span class="o">.</span><span class="n">IP</span>
<span class="p">)</span>

<span class="c1"># Create a rule for specific paths</span>
<span class="n">api_rule</span> <span class="o">=</span> <span class="n">RateLimitRule</span><span class="p">(</span>
    <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="n">RateLimitStrategy</span><span class="o">.</span><span class="n">COMBINED</span><span class="p">,</span>
    <span class="n">path_pattern</span><span class="o">=</span><span class="s2">&quot;/api/v1/&quot;</span><span class="p">,</span>
    <span class="n">exclude_paths</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;/api/v1/health&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/v1/docs&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Create a rule with burst allowance</span>
<span class="n">auth_rule</span> <span class="o">=</span> <span class="n">RateLimitRule</span><span class="p">(</span>
    <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="n">RateLimitStrategy</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span>
    <span class="n">burst_multiplier</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># Allow up to 40 requests in bursts</span>
    <span class="n">path_pattern</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth/&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="basic-usage-with-middleware">
<h3>Basic Usage with Middleware<a class="headerlink" href="#basic-usage-with-middleware" title="Link to this heading"></a></h3>
<p>The simplest way to use rate limiting is through middleware:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware.rate_limiting</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitRule</span><span class="p">,</span> <span class="n">RateLimitStrategy</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="c1"># Add rate limiting middleware</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">RateLimitMiddleware</span><span class="p">,</span>
    <span class="n">rules</span><span class="o">=</span><span class="p">[</span>
        <span class="n">RateLimitRule</span><span class="p">(</span>
            <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="n">RateLimitStrategy</span><span class="o">.</span><span class="n">IP</span>
        <span class="p">),</span>
        <span class="n">RateLimitRule</span><span class="p">(</span>
            <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="n">RateLimitStrategy</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span>
            <span class="n">path_pattern</span><span class="o">=</span><span class="s2">&quot;/api/v1/auth/&quot;</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">use_redis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">block_exceeding_requests</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-the-rate-limiting-service">
<h3>Using the Rate Limiting Service<a class="headerlink" href="#using-the-rate-limiting-service" title="Link to this heading"></a></h3>
<p>For more control, you can use the rate limiting service directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_rate_limiting_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitRule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitExceededException</span>

<span class="c1"># In FastAPI endpoints</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/custom-rate-limited&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">custom_rate_limited_endpoint</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">):</span>
    <span class="c1"># Get rate limiting service</span>
    <span class="n">rate_limiting_service</span> <span class="o">=</span> <span class="n">get_rate_limiting_service</span><span class="p">()</span>

    <span class="c1"># Define custom rule for this endpoint</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="n">RateLimitRule</span><span class="p">(</span>
        <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span>
    <span class="p">)</span>

    <span class="c1"># Get key for current request</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">rate_limiting_service</span><span class="o">.</span><span class="n">get_key_for_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>

    <span class="c1"># Check rate limit</span>
    <span class="n">is_limited</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rate_limiting_service</span><span class="o">.</span><span class="n">is_rate_limited</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>

    <span class="c1"># Handle rate limit exceeded</span>
    <span class="k">if</span> <span class="n">is_limited</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;X-RateLimit-Limit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span>
            <span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;X-RateLimit-Reset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">window_seconds</span><span class="p">),</span>
            <span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">window_seconds</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">raise</span> <span class="n">RateLimitExceededException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Custom rate limit exceeded&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">reset_seconds</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">window_seconds</span>
        <span class="p">)</span>

    <span class="c1"># Process the request</span>
    <span class="c1"># ...</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;rate_limit&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="manual-rate-limiting">
<h3>Manual Rate Limiting<a class="headerlink" href="#manual-rate-limiting" title="Link to this heading"></a></h3>
<p>For specific operations that need rate limiting within the application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_rate_limit</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Check if user has exceeded email sending limit</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;email:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">is_limited</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">reset_seconds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">check_rate_limit</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
        <span class="n">max_requests</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># 10 emails</span>
        <span class="n">window_seconds</span><span class="o">=</span><span class="mi">3600</span>  <span class="c1"># per hour</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_limited</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Email rate limit exceeded&quot;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">current_count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
            <span class="n">reset_seconds</span><span class="o">=</span><span class="n">reset_seconds</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">RateLimitExceededException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Email sending limit exceeded&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="s2">&quot;1 hour&quot;</span><span class="p">},</span>
            <span class="n">reset_seconds</span><span class="o">=</span><span class="n">reset_seconds</span>
        <span class="p">)</span>

    <span class="c1"># Send email</span>
    <span class="c1"># ...</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="exception-handling">
<h3>Exception Handling<a class="headerlink" href="#exception-handling" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.rate_limiting.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitExceededException</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">RateLimitExceededException</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limit_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">RateLimitExceededException</span><span class="p">):</span>
    <span class="c1"># Get response headers from exception</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;headers&quot;</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">details</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;RATE_LIMIT_EXCEEDED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">,</span> <span class="s2">&quot;60&quot;</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>Integration with Metrics<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>The rate limiting system automatically integrates with the metrics system to track performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># These metrics are recorded automatically when using the rate limiting service</span>
<span class="c1"># - rate_limit_exceeded_total (counter)</span>
<span class="c1"># - rate_limiting_requests_total (counter)</span>
<span class="c1"># - rate_limiting_middleware_duration_seconds (histogram)</span>
<span class="c1"># - rate_limiting_check_duration_seconds (histogram)</span>
<span class="c1"># - rate_limiting_checks_total (counter)</span>

<span class="c1"># Example metrics queries for Prometheus:</span>
<span class="c1"># - rate(rate_limit_exceeded_total[5m]) # Rate of exceeded limits in the last 5 minutes</span>
<span class="c1"># - sum by (path) (rate_limit_exceeded_total) # Total exceeded limits by path</span>
<span class="c1"># - histogram_quantile(0.95, sum(rate_limiting_check_duration_seconds_bucket) by (le)) # 95th percentile rate limit check duration</span>
</pre></div>
</div>
</section>
</section>
<section id="common-patterns">
<h2>9. Common Patterns<a class="headerlink" href="#common-patterns" title="Link to this heading"></a></h2>
<section id="api-endpoint-error-handling-with-rate-limiting">
<h3>API Endpoint Error Handling with Rate Limiting<a class="headerlink" href="#api-endpoint-error-handling-with-rate-limiting" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_products</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get product service</span>
        <span class="n">product_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;product_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

        <span class="c1"># Apply pagination</span>
        <span class="n">pagination_params</span> <span class="o">=</span> <span class="n">OffsetPaginationParams</span><span class="p">(</span>
            <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
            <span class="n">page_size</span><span class="o">=</span><span class="n">page_size</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">SortField</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">SortDirection</span><span class="o">.</span><span class="n">DESC</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">product_service</span><span class="o">.</span><span class="n">list_products</span><span class="p">(</span><span class="n">pagination_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="n">RateLimitExceededException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># This exception is already properly formatted by the exception handlers</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">ResourceNotFoundException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># App exceptions are automatically converted to proper responses</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># For unexpected errors, report and re-raise</span>
        <span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">raise</span>
</pre></div>
</div>
</section>
<section id="standard-api-endpoint-error-handling">
<h3>Standard API Endpoint Error Handling<a class="headerlink" href="#standard-api-endpoint-error-handling" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;user_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="k">except</span> <span class="n">ResourceNotFoundException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># App exceptions are automatically converted to proper responses</span>
        <span class="c1"># by the exception handlers, so just re-raise</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># For unexpected errors, report and re-raise</span>
        <span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">raise</span>
</pre></div>
</div>
</section>
<section id="rate-limited-service-methods">
<h3>Rate Limited Service Methods<a class="headerlink" href="#rate-limited-service-methods" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AnalyticsService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;app.domains.analytics.service&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiting_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;rate_limiting_service&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">report_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a complex analytical report.</span>

<span class="sd">        This method is rate limited to prevent resource abuse.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generate report requested&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">report_type</span><span class="o">=</span><span class="n">report_type</span><span class="p">)</span>

        <span class="c1"># Define a rate limit rule for report generation</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">RateLimitRule</span><span class="p">(</span>
            <span class="n">requests_per_window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 5 reports</span>
            <span class="n">window_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>    <span class="c1"># per hour</span>
            <span class="n">strategy</span><span class="o">=</span><span class="n">RateLimitStrategy</span><span class="o">.</span><span class="n">USER</span>
        <span class="p">)</span>

        <span class="c1"># Use user ID directly as the key for consistent limits</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;report_generation:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check rate limit</span>
        <span class="n">is_limited</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiting_service</span><span class="o">.</span><span class="n">is_rate_limited</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_limited</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Report generation rate limit exceeded&quot;</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">report_type</span><span class="o">=</span><span class="n">report_type</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">RateLimitExceededException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Report generation limit exceeded&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
                    <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="s2">&quot;1 hour&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;report_type&quot;</span><span class="p">:</span> <span class="n">report_type</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Generate report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Generating report&quot;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">report_type</span><span class="o">=</span><span class="n">report_type</span><span class="p">,</span>
            <span class="n">remaining_limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">-</span> <span class="n">count</span>
        <span class="p">)</span>

        <span class="c1"># Complex report logic...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Report generated successfully&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">report_type</span><span class="o">=</span><span class="n">report_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span>
</pre></div>
</div>
</section>
<section id="service-layer-error-handling-and-logging">
<h3>Service Layer Error Handling and Logging<a class="headerlink" href="#service-layer-error-handling-and-logging" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">OrderService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;error_service&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;app.domains.orders.service&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating order&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">items_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">order_data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]))</span>

        <span class="c1"># Validate inventory availability</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">product</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Product not found&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_service</span><span class="o">.</span><span class="n">resource_not_found</span><span class="p">(</span>
                    <span class="n">resource_type</span><span class="o">=</span><span class="s2">&quot;Product&quot;</span><span class="p">,</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="n">stock</span> <span class="o">&lt;</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Insufficient inventory&quot;</span><span class="p">,</span>
                    <span class="n">product_id</span><span class="o">=</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">requested</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
                    <span class="n">available</span><span class="o">=</span><span class="n">product</span><span class="o">.</span><span class="n">stock</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_service</span><span class="o">.</span><span class="n">business_logic_error</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Insufficient inventory&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;requested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;available&quot;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">stock</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Process order...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Order created successfully&quot;</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="n">new_order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_order</span>
</pre></div>
</div>
</section>
<section id="validation-in-services">
<h3>Validation in Services<a class="headerlink" href="#validation-in-services" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;validation_service&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;app.domains.users.service&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new user&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">))</span>

        <span class="c1"># Validate data against schema</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validated_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_service</span><span class="o">.</span><span class="n">validate_data</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="n">UserCreateSchema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User data validation failed&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Check for unique email</span>
        <span class="n">is_unique</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_service</span><span class="o">.</span><span class="n">validate_unique</span><span class="p">(</span>
            <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">User</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_unique</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Email already exists&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">validated_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
                <span class="s2">&quot;Validation error&quot;</span><span class="p">,</span>
                <span class="n">errors</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Email already registered&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unique_error&quot;</span>
                <span class="p">}]</span>
            <span class="p">)</span>

        <span class="c1"># Create user</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User created successfully&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
</pre></div>
</div>
</section>
<section id="metrics-in-services">
<h3>Metrics in Services<a class="headerlink" href="#metrics-in-services" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProductService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;app.domains.products.service&quot;</span><span class="p">)</span>

    <span class="nd">@track_db_select</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;product&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_products</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching products&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>

        <span class="c1"># Track search operation</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">result_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Perform search</span>
            <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>
            <span class="n">result_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">products</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># Track search metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_service</span><span class="o">.</span><span class="n">track_service_call</span><span class="p">(</span>
                <span class="n">component</span><span class="o">=</span><span class="s2">&quot;product_service&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error</span>
            <span class="p">)</span>

            <span class="c1"># Track result count</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics_service</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span>
                    <span class="s2">&quot;product_search_result_count&quot;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span> <span class="k">if</span> <span class="n">query</span> <span class="k">else</span> <span class="s2">&quot;filter&quot;</span><span class="p">}</span>
                <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="logging-best-practices">
<h3>Logging Best Practices<a class="headerlink" href="#logging-best-practices" title="Link to this heading"></a></h3>
<ol class="arabic">
<li><p><strong>Use Structured Logging</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good - structured and searchable</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User registered&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">registration_source</span><span class="o">=</span><span class="s2">&quot;web&quot;</span><span class="p">)</span>

<span class="c1"># Avoid - unstructured string concatenation</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> with email </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2"> registered from web&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Choose Appropriate Log Levels</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>: Detailed information, typically useful only when diagnosing problems</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFO</span></code>: Confirmation that things are working as expected</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WARNING</span></code>: An indication that something unexpected happened, but the application still works</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERROR</span></code>: The application has encountered an error that prevents a function from working</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CRITICAL</span></code>: A serious error that prevents the application from continuing to function</p></li>
</ul>
</li>
<li><p><strong>Include Context</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Include relevant context with every log</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;Payment processed&quot;</span><span class="p">,</span>
    <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">payment_id</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">amount</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
    <span class="n">status</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">status</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Use Request Context When Available</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Request context is automatically included</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing request&quot;</span><span class="p">)</span>  <span class="c1"># Will include request_id and user_id automatically</span>
</pre></div>
</div>
</li>
<li><p><strong>Log at Service Boundaries</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Log at service boundaries and important events</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting external API call&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create_payment&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stripe_client</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span><span class="n">payment_data</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;External API call succeeded&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">,</span> <span class="n">duration_ms</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;External API call failed&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">raise</span>
</pre></div>
</div>
</li>
<li><p><strong>Use Decorators for Common Patterns</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@log_execution_time</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_report</span><span class="p">(</span><span class="n">report_id</span><span class="p">):</span>
    <span class="c1"># Complex processing...</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</li>
<li><p><strong>Avoid Sensitive Information</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Don&#39;t log passwords, tokens, or other secrets</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User authentication&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>  <span class="c1"># Good</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User authentication&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>  <span class="c1"># BAD!</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="caching-with-fallback-and-metrics">
<h3>Caching with Fallback and Metrics<a class="headerlink" href="#caching-with-fallback-and-metrics" title="Link to this heading"></a></h3>
<p>This pattern demonstrates how to implement robust caching with proper fallback mechanisms, metrics tracking, and integration with the error handling system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.cache.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheOperationException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.error</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_exception</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;app.services.product_service&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProductService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;cache_service&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_product_with_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get product with complete details, using caching with proper fallback.</span>

<span class="sd">        This method demonstrates caching with:</span>
<span class="sd">        1. Proper key generation</span>
<span class="sd">        2. Error handling with fallback</span>
<span class="sd">        3. Metrics tracking</span>
<span class="sd">        4. Cache invalidation on updates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching product with details&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>

        <span class="c1"># Define cache key</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;product:details:</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Start metrics timer</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">cache_hit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to get from cache first</span>
            <span class="n">cached_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cached_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cache hit for product details&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
                <span class="n">cache_hit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">cached_data</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cache miss for product details&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>

            <span class="c1"># Get from database</span>
            <span class="n">product</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">Product</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">product</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Product not found&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Get additional data</span>
            <span class="n">reviews</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">Review</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">product_id</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">reviews</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">reviews</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

            <span class="n">inventory</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_repository</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>
            <span class="n">related_products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_products</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>

            <span class="c1"># Combine into a complete response</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reviews</span><span class="p">],</span>
                <span class="s2">&quot;inventory&quot;</span><span class="p">:</span> <span class="n">inventory</span><span class="p">,</span>
                <span class="s2">&quot;related_products&quot;</span><span class="p">:</span> <span class="n">related_products</span><span class="p">,</span>
                <span class="s2">&quot;calculated_rating&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_rating</span><span class="p">(</span><span class="n">reviews</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="c1"># Cache the result (15 minutes TTL)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">cache_key</span><span class="p">,</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">ttl</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
                    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;product:</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">CacheOperationException</span> <span class="k">as</span> <span class="n">cache_err</span><span class="p">:</span>
                <span class="c1"># Log but don&#39;t fail if caching fails</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to cache product details&quot;</span><span class="p">,</span>
                    <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cache_err</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle and report the exception</span>
            <span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error fetching product details&quot;</span><span class="p">,</span>
                <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Record metrics regardless of success/failure</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_service</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
                <span class="s2">&quot;product_details_duration_seconds&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;cache_hit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_hit</span><span class="p">),</span>
                    <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="n">product_id</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># First 5 chars for cardinality</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update product data and invalidate related caches.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating product&quot;</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Update in database</span>
            <span class="n">product</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

            <span class="c1"># Invalidate caches</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Invalidate specific product cache</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;product:details:</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Invalidate any list caches that might contain this product</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">invalidate_pattern</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;products:list:*&quot;</span><span class="p">)</span>

                <span class="c1"># If using Redis with tags</span>
                <span class="n">redis_backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">_get_backend</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">redis_backend</span><span class="p">,</span> <span class="s2">&quot;get_set_members&quot;</span><span class="p">):</span>
                    <span class="c1"># Invalidate all caches tagged with this product</span>
                    <span class="n">tag_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cache:tag:product:</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">tagged_keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis_backend</span><span class="o">.</span><span class="n">get_set_members</span><span class="p">(</span><span class="n">tag_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tagged_keys</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="n">tagged_keys</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">redis_backend</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tag_key</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cache_err</span><span class="p">:</span>
                <span class="c1"># Log but continue if cache invalidation fails</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to invalidate cache for product update&quot;</span><span class="p">,</span>
                    <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cache_err</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Audit log the update</span>
            <span class="n">audit_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;audit_service&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">audit_service</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;product_update&quot;</span><span class="p">,</span>
                <span class="n">resource_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fields_updated&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">product</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">raise</span>
</pre></div>
</div>
<p>This pattern demonstrates several important practices:</p>
<ol class="arabic simple">
<li><p><strong>Proper cache key generation</strong> - Using consistent, structured cache keys</p></li>
<li><p><strong>Error handling with fallback</strong> - Gracefully handling cache failures without affecting core functionality</p></li>
<li><p><strong>Cache invalidation strategy</strong> - Both targeted invalidation and pattern-based invalidation</p></li>
<li><p><strong>Metrics tracking</strong> - Recording performance metrics for both cache hits and misses</p></li>
<li><p><strong>Integration with other systems</strong> - Working with logging, metrics, and error handling</p></li>
<li><p><strong>Tag-based invalidation</strong> - Using Redis tags for grouped invalidation</p></li>
<li><p><strong>Audit logging</strong> - Recording significant data changes</p></li>
</ol>
<p>The above example can be adapted for various types of data and services while maintaining the same core principles of robust caching.</p>
</section>
</section>
<section id="cache-system">
<h2>10. Cache System<a class="headerlink" href="#cache-system" title="Link to this heading"></a></h2>
<p>The cache system provides a flexible, configurable caching mechanism that supports multiple backends (memory, Redis, etc.) and offers various caching strategies.</p>
<section id="id8">
<h3>Key Features<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Multiple cache backends (Memory, Redis, Null)</p></li>
<li><p>Key generation utilities for consistent caching</p></li>
<li><p>Function decorators for easy caching</p></li>
<li><p>Integration with metrics system</p></li>
<li><p>Customizable TTL (time-to-live)</p></li>
<li><p>Cache invalidation patterns</p></li>
<li><p>Tagged caching for bulk invalidation</p></li>
<li><p>Exception handling and resilience</p></li>
<li><p>Service pattern for dependency injection</p></li>
</ul>
</section>
<section id="id9">
<h3>Basic Usage<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="c1"># Get the cache service</span>
<span class="n">cache_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;cache_service&quot;</span><span class="p">)</span>

<span class="c1"># Basic cache operations</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Try to get from cache first</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user:profile:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">cached_profile</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cached_profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached_profile</span>

    <span class="c1"># Not in cache, fetch from database</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_repository</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="c1"># Store in cache for future requests (TTL: 10 minutes)</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profile</span>
</pre></div>
</div>
</section>
<section id="using-decorators">
<h3>Using Decorators<a class="headerlink" href="#using-decorators" title="Link to this heading"></a></h3>
<p>The cache system provides decorators for easy function-level caching:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached</span><span class="p">,</span> <span class="n">invalidate_cache</span>

<span class="c1"># Cache the result of this function for 5 minutes</span>
<span class="nd">@cached</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_product_details</span><span class="p">(</span><span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># This expensive operation will only run on cache misses</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">product_repository</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Invalidate cache entries when data changes</span>
<span class="nd">@invalidate_cache</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;product:*&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="c1"># This will invalidate all cache keys matching the pattern</span>
    <span class="k">await</span> <span class="n">product_repository</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="advanced-caching-patterns">
<h3>Advanced Caching Patterns<a class="headerlink" href="#advanced-caching-patterns" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached</span><span class="p">,</span> <span class="n">cache_aside</span><span class="p">,</span> <span class="n">memoize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.cache.keys</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_model_key</span><span class="p">,</span> <span class="n">generate_list_key</span>

<span class="c1"># Memoize an expensive function (in-memory caching)</span>
<span class="nd">@memoize</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 60 seconds</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_complex_value</span><span class="p">(</span><span class="n">input_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># Complex calculation</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Cache using custom key generation</span>
<span class="nd">@cache_aside</span><span class="p">(</span>
    <span class="n">key_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">category_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">generate_list_key</span><span class="p">(</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;products&quot;</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;product&quot;</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="n">category_id</span><span class="p">}</span>
    <span class="p">),</span>
    <span class="n">ttl</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="s2">&quot;catalog&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_products_by_category</span><span class="p">(</span><span class="n">category_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Fetch from database</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">product_repository</span><span class="o">.</span><span class="n">list_by_category</span><span class="p">(</span><span class="n">category_id</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cache-tags-for-group-invalidation">
<h3>Cache Tags for Group Invalidation<a class="headerlink" href="#cache-tags-for-group-invalidation" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.dependency_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_service</span>

<span class="n">cache_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;cache_service&quot;</span><span class="p">)</span>

<span class="c1"># Invalidate all product-related cache entries</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clear_product_cache</span><span class="p">():</span>
    <span class="c1"># Get Redis backend</span>
    <span class="n">redis_backend</span> <span class="o">=</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">_get_backend</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">)</span>

    <span class="c1"># Get all keys with product tag</span>
    <span class="n">tag_key</span> <span class="o">=</span> <span class="s2">&quot;cache:tag:products&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis_backend</span><span class="o">.</span><span class="n">get_set_members</span><span class="p">(</span><span class="n">tag_key</span><span class="p">)</span>

    <span class="c1"># Delete all keys</span>
    <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

        <span class="c1"># Also remove the tag itself</span>
        <span class="k">await</span> <span class="n">redis_backend</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tag_key</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;invalidated&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)}</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3>Exception Handling<a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.cache.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheException</span><span class="p">,</span> <span class="n">CacheOperationException</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_cached_data</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;cache_service&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">CacheOperationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache operation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Fallback to database</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">fetch_from_database</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">CacheException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache system error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># More severe error, may need to be reported</span>
        <span class="k">raise</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3>Integration with Metrics<a class="headerlink" href="#id11" title="Link to this heading"></a></h3>
<p>The cache system automatically tracks metrics:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cache_hit_total</span></code> - Counter of cache hits</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cache_miss_total</span></code> - Counter of cache misses</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cache_operations_total</span></code> - Counter of all cache operations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cache_operation_duration_seconds</span></code> - Histogram of cache operation durations</p></li>
</ul>
<p>These metrics can be used to monitor cache effectiveness:</p>
<ul class="simple">
<li><p>Hit rate: <code class="docutils literal notranslate"><span class="pre">sum(rate(cache_hit_total[5m]))</span> <span class="pre">/</span> <span class="pre">sum(rate(cache_operations_total[5m]))</span></code></p></li>
<li><p>Miss rate: <code class="docutils literal notranslate"><span class="pre">sum(rate(cache_miss_total[5m]))</span> <span class="pre">/</span> <span class="pre">sum(rate(cache_operations_total[5m]))</span></code></p></li>
<li><p>Operation latency: <code class="docutils literal notranslate"><span class="pre">histogram_quantile(0.95,</span> <span class="pre">sum(rate(cache_operation_duration_seconds_bucket[5m]))</span> <span class="pre">by</span> <span class="pre">(le))</span></code></p></li>
</ul>
</section>
<section id="system-integration">
<h3>System Integration<a class="headerlink" href="#system-integration" title="Link to this heading"></a></h3>
<p>The cache system is designed to seamlessly integrate with other application systems:</p>
<section id="error-handling-integration">
<h4>Error Handling Integration<a class="headerlink" href="#error-handling-integration" title="Link to this heading"></a></h4>
<p>The cache system uses a dedicated exception hierarchy that integrates with the application’s exception system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.cache.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheException</span><span class="p">,</span> <span class="n">CacheOperationException</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">CacheOperationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Handle specific operation errors</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache operation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Fallback logic</span>
<span class="k">except</span> <span class="n">CacheException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Handle general cache errors</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># More severe error handling</span>
</pre></div>
</div>
<p>When cache operations fail, the system will automatically log errors with appropriate context and fall back to database operations where possible, rather than causing application failures.</p>
</section>
<section id="metrics-integration">
<h4>Metrics Integration<a class="headerlink" href="#metrics-integration" title="Link to this heading"></a></h4>
<p>Cache operations are automatically tracked with the metrics system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># These metrics are available automatically</span>
<span class="n">metrics_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;metrics_service&quot;</span><span class="p">)</span>

<span class="c1"># Get hit rate over the last 5 minutes</span>
<span class="n">hit_rate</span> <span class="o">=</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">get_counter_rate</span><span class="p">(</span><span class="s2">&quot;cache_hit_total&quot;</span><span class="p">)</span> <span class="o">/</span> \
           <span class="n">metrics_service</span><span class="o">.</span><span class="n">get_counter_rate</span><span class="p">(</span><span class="s2">&quot;cache_operations_total&quot;</span><span class="p">)</span>

<span class="c1"># Get p95 latency for cache operations</span>
<span class="n">latency</span> <span class="o">=</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">get_histogram_quantile</span><span class="p">(</span>
    <span class="s2">&quot;cache_operation_duration_seconds&quot;</span><span class="p">,</span>
    <span class="mf">0.95</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;product_service&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Get miss count by backend</span>
<span class="n">miss_count</span> <span class="o">=</span> <span class="n">metrics_service</span><span class="o">.</span><span class="n">get_counter_sum</span><span class="p">(</span>
    <span class="s2">&quot;cache_miss_total&quot;</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;backend&quot;</span><span class="p">:</span> <span class="s2">&quot;redis&quot;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id12">
<h4>Dependency Injection<a class="headerlink" href="#id12" title="Link to this heading"></a></h4>
<p>The cache service is automatically registered with the dependency manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In service classes</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProductService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span> <span class="o">=</span> <span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;cache_service&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">):</span>
        <span class="c1"># Use cache service</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;product:</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">product</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">product</span>

        <span class="c1"># Cache miss - get from database</span>
        <span class="n">product</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">Product</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

        <span class="c1"># Cache for next time</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">product</span>
</pre></div>
</div>
</section>
</section>
<section id="id13">
<h3>Configuration<a class="headerlink" href="#id13" title="Link to this heading"></a></h3>
<p>The cache system can be configured in the settings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In settings.py or .env</span>

<span class="c1"># Cache backend settings</span>
<span class="n">CACHE_DEFAULT_BACKEND</span><span class="o">=</span><span class="s2">&quot;redis&quot;</span>  <span class="c1"># &quot;redis&quot;, &quot;memory&quot;, or &quot;null&quot;</span>

<span class="c1"># Redis connection settings</span>
<span class="n">REDIS_HOST</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span>
<span class="n">REDIS_PORT</span><span class="o">=</span><span class="mi">6379</span>
<span class="n">REDIS_DB</span><span class="o">=</span><span class="mi">0</span>
<span class="n">REDIS_PASSWORD</span><span class="o">=</span><span class="s2">&quot;optional_password&quot;</span>
<span class="n">REDIS_URI</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379/0&quot;</span>

<span class="c1"># Default TTL settings (in seconds)</span>
<span class="n">CACHE_DEFAULT_TTL</span><span class="o">=</span><span class="mi">300</span>  <span class="c1"># 5 minutes</span>
</pre></div>
</div>
</section>
<section id="available-backends">
<h3>Available Backends<a class="headerlink" href="#available-backends" title="Link to this heading"></a></h3>
<p>The cache system provides multiple backends:</p>
<ol class="arabic simple">
<li><p><strong>Redis Backend</strong>: Production-ready backend with all features, including pattern-based invalidation, atomic counters, and tag-based operations. Recommended for production.</p></li>
<li><p><strong>Memory Backend</strong>: In-process memory cache. Fast but doesn’t persist or share between processes. Good for development, testing, or as a fallback when Redis is unavailable.</p></li>
<li><p><strong>Null Backend</strong>: A non-caching implementation that acts like a cache but doesn’t store anything. Useful for testing or disabling caching without changing code.</p></li>
</ol>
<p>The system automatically falls back to the memory backend if Redis is unavailable, ensuring resilience.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Crown Nexus Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="autoapi/index.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ryan Serra.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>