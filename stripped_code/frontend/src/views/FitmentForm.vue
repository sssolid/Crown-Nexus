<!-- frontend/src/views/FitmentForm.vue --><template><div><v-container fluid><div v-if="initialLoading" class="d-flex justify-center my-6"><v-progress-circular indeterminate color="primary" size="64" ></v-progress-circular></div><template v-else><v-row class="mb-6"><v-col cols="12"><div class="d-flex align-center"><v-btn icon variant="text" @click="router.back()" class="mr-4" ><v-icon>mdi-arrow-left</v-icon></v-btn><div><h1 class="text-h3 font-weight-bold"> {{ isEditMode ? 'Edit Fitment' : 'Create Fitment' }} </h1><p class="text-subtitle-1"> {{ isEditMode ? `Editing ${form.year} ${form.make} ${form.model}` : 'Add a new vehicle fitment' }} </p></div></div></v-col></v-row><v-form ref="formRef" @submit.prevent="submitForm" v-model="isFormValid"><v-row><v-col cols="12" md="8"><v-card class="mb-6"><v-card-title>Vehicle Information</v-card-title><v-divider></v-divider><v-card-text><v-row><v-col cols="12" md="4"><v-text-field v-model.number="form.year" label="Year" type="number" variant="outlined" :rules="[rules.required, rules.yearValid]" :error-messages="errors.year" :disabled="loading" @input="clearError('year')" required ></v-text-field></v-col><v-col cols="12" md="4"><v-autocomplete v-model="form.make" label="Make" :items="makeOptions" variant="outlined" :rules="[rules.required]" :error-messages="errors.make" :disabled="loading" @input="clearError('make')" required clearable ></v-autocomplete></v-col><v-col cols="12" md="4"><v-autocomplete v-model="form.model" label="Model" :items="modelOptions" variant="outlined" :rules="[rules.required]" :error-messages="errors.model" :disabled="loading" @input="clearError('model')" required clearable ></v-autocomplete></v-col><v-col cols="12" md="6"><v-autocomplete v-model="form.engine" label="Engine" :items="engineOptions" variant="outlined" :error-messages="errors.engine" :disabled="loading" @input="clearError('engine')" clearable hint="Optional engine specification" persistent-hint ></v-autocomplete></v-col><v-col cols="12" md="6"><v-autocomplete v-model="form.transmission" label="Transmission" :items="transmissionOptions" variant="outlined" :error-messages="errors.transmission" :disabled="loading" @input="clearError('transmission')" clearable hint="Optional transmission specification" persistent-hint ></v-autocomplete></v-col></v-row></v-card-text></v-card><v-card class="mb-6"><v-card-title class="d-flex align-center"> Additional Attributes <v-spacer></v-spacer><v-btn color="primary" size="small" variant="text" prepend-icon="mdi-plus" @click="addAttribute" :disabled="loading" > Add Attribute </v-btn></v-card-title><v-divider></v-divider><v-card-text><div v-if="attributes.length===0" class="text-center py-4"><v-icon icon="mdi-car-off" size="large" class="mb-2"></v-icon><p>No additional attributes added yet. Click "Add Attribute" to add vehicle specifications.</p></div><v-row v-for="(attr, index) in attributes" :key="index" class="align-center"><v-col cols="5"><v-text-field v-model="attr.key" label="Attribute Name" variant="outlined" density="comfortable" :disabled="loading" placeholder="e.g. Trim, Body Style, Drivetrain" ></v-text-field></v-col><v-col cols="5"><v-text-field v-model="attr.value" label="Value" variant="outlined" density="comfortable" :disabled="loading" ></v-text-field></v-col><v-col cols="2" class="d-flex justify-end"><v-btn icon color="error" variant="text" @click="removeAttribute(index)" :disabled="loading" ><v-icon>mdi-delete</v-icon></v-btn></v-col></v-row></v-card-text></v-card></v-col><v-col cols="12" md="4"><v-card class="mb-6"><v-card-title>Save Changes</v-card-title><v-divider></v-divider><v-card-text><p class="mb-4"> {{ isEditMode ? 'Update this fitment with your changes.' : 'Create a new vehicle fitment.' }} </p><v-alert v-if="formError" type="error" variant="tonal" class="mb-4" closable @click:close="formError=''" > {{ formError }} </v-alert></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn variant="text" color="secondary" @click="router.back()" :disabled="loading" > Cancel </v-btn><v-btn color="primary" type="submit" :loading="loading" :disabled="!isFormValid" @click="submitForm" > {{ isEditMode ? 'Update Fitment' : 'Create Fitment' }} </v-btn></v-card-actions></v-card><v-card v-if="isEditMode"><v-card-title>Associated Products</v-card-title><v-divider></v-divider><v-card-text v-if="associatedProducts.length > 0"><v-list lines="two"><v-list-item v-for="product in associatedProducts" :key="product.id" :to="{ name: 'ProductDetail', params: { id: product.id } }" ><template v-slot:prepend><v-avatar color="primary" variant="tonal"><v-icon>mdi-package-variant-closed</v-icon></v-avatar></template><v-list-item-title>{{ product.name }}</v-list-item-title><v-list-item-subtitle>SKU: {{ product.sku }}</v-list-item-subtitle></v-list-item></v-list></v-card-text><v-card-text v-else class="text-center py-4"><v-icon icon="mdi-package-variant-closed-remove" size="large" class="mb-2"></v-icon><p>No products associated with this fitment yet.</p></v-card-text><v-divider></v-divider><v-card-actions class="pa-4"><v-btn block color="primary" variant="outlined" prepend-icon="mdi-link" :disabled="loading" > Manage Product Associations </v-btn></v-card-actions></v-card></v-col></v-row></v-form><!-- Unsaved Changes Dialog --><v-dialog v-model="showUnsavedDialog" max-width="500"><v-card><v-card-title class="text-h5 bg-warning pa-4"> Unsaved Changes </v-card-title><v-card-text class="pa-4 pt-6"><p>You have unsaved changes. Are you sure you want to leave this page?</p></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn color="primary" variant="tonal" @click="showUnsavedDialog = false" > Stay on Page </v-btn><v-btn color="error" @click="discardChanges" > Discard Changes </v-btn></v-card-actions></v-card></v-dialog></template></v-container></div></template><script lang="ts">import{defineComponent,ref,computed,onMounted,onBeforeUnmount,watch}from 'vue';import{useRouter,useRoute}from 'vue-router';import{useAuthStore}from '@/stores/auth';import fitmentService from '@/services/fitment';import{Fitment}from '@/types/fitment';import{notificationService}from '@/utils/notification';import{parseValidationErrors}from '@/utils/error-handler';import{Product}from '@/types/product';interface FitmentForm{year:number;make:string;model:string;engine?:string;transmission?:string;attributes:Record<string,any>;}interface AttributeItem{key:string;value:string;}export default defineComponent({name:'FitmentForm',setup(){const router=useRouter();const route=useRoute();const authStore=useAuthStore();const formRef=ref<any>(null);const isFormValid=ref(false);const initialLoading=ref(false);const loading=ref(false);const formError=ref('');const errors=ref<Record<string,string>>({});const form=ref<FitmentForm>({year:new Date().getFullYear(),make:'',model:'',engine:undefined,transmission:undefined,attributes:{}});const formDirty=ref(false);const showUnsavedDialog=ref(false);const pendingNavigation=ref<any>(null);const attributes=ref<AttributeItem[]>([]);const associatedProducts=ref<Product[]>([]);const makeOptions=ref<string[]>(['Toyota','Honda','Ford','Chevrolet','Nissan','BMW','Mercedes-Benz','Audi','Subaru','Mazda','Lexus','Volkswagen','Jeep','Hyundai','Kia']);const modelOptions=ref<string[]>(['Camry','Accord','F-150','Silverado','Altima','3 Series','C-Class','A4','Outback','CX-5','RX','Golf','Wrangler','Elantra','Sportage']);const engineOptions=ref<string[]>(['2.0L I4','2.5L I4','3.0L V6','3.5L V6','4.0L V6','5.0L V8','5.7L V8','2.0L Turbo','3.0L Turbo','1.5L I4','1.8L I4','2.4L I4','6.2L V8']);const transmissionOptions=ref<string[]>(['Automatic','Manual','CVT','Dual-Clutch','6-Speed Automatic','8-Speed Automatic','10-Speed Automatic','9-Speed Automatic','5-Speed Manual']);const navigationGuard=(event:BeforeUnloadEvent)=>{if(formDirty.value){event.preventDefault();event.returnValue='';}};onMounted(()=>{window.addEventListener('beforeunload',navigationGuard);});onBeforeUnmount(()=>{window.removeEventListener('beforeunload',navigationGuard);});const isEditMode=computed(()=>{return route.name==='FitmentEdit';});const fitmentId=computed(()=>{return route.params.id as string;});const rules={required:(v:any)=>!!v||'This field is required',yearValid:(v:number)=>{const currentYear=new Date().getFullYear();return(v>=1900&&v<=currentYear+1)||'Year must be between 1900 and '+(currentYear+1);}};const clearError=(field:string)=>{if(errors.value[field]){delete errors.value[field];}formDirty.value=true;};const addAttribute=()=>{attributes.value.push({key:'',value:''});formDirty.value=true;};const removeAttribute=(index:number)=>{attributes.value.splice(index,1);formDirty.value=true;};const attributesToObject=():Record<string,any>=>{const result:Record<string,any>={};attributes.value.forEach(attr=>{if(attr.key&&attr.value){result[attr.key]=attr.value;}});return result;};const objectToAttributes=(obj:Record<string,any>)=>{const result:AttributeItem[]=[];Object.entries(obj).forEach(([key,value])=>{result.push({key,value:String(value)});});return result;};const fetchFitment=async()=>{if(!isEditMode.value)return;initialLoading.value=true;try{const fitment=await fitmentService.getFitment(fitmentId.value);form.value.year=fitment.year;form.value.make=fitment.make;form.value.model=fitment.model;form.value.engine=fitment.engine;form.value.transmission=fitment.transmission;if(fitment.attributes&&Object.keys(fitment.attributes).length>0){attributes.value=objectToAttributes(fitment.attributes);}formDirty.value=false;fetchAssociatedProducts();}catch(error){console.error('Error fetching fitment:',error);notificationService.error('Failed to load fitment data');router.push({name:'FitmentCatalog'});}finally{initialLoading.value=false;}};const fetchAssociatedProducts=async()=>{if(!isEditMode.value)return;try{const products=await fitmentService.getFitmentProducts(fitmentId.value);associatedProducts.value=products;}catch(error){console.error('Error fetching associated products:',error);}};const submitForm=async()=>{const validation=await formRef.value?.validate();if(!validation.valid){formError.value='Please correct the errors in the form';return;}loading.value=true;formError.value='';errors.value={};try{form.value.attributes=attributesToObject();let result:Fitment;if(isEditMode.value){result=await fitmentService.updateFitment(fitmentId.value,form.value);notificationService.success('Fitment updated successfully');}else{result=await fitmentService.createFitment(form.value);notificationService.success('Fitment created successfully');}formDirty.value=false;router.push({name:'FitmentDetail',params:{id:result.id}});}catch(error:any){console.error('Error submitting fitment:',error);if(error.response?.status===422){errors.value=parseValidationErrors(error);formError.value='Please correct the validation errors';}else{formError.value=error.response?.data?.detail||'Failed to save fitment';}}finally{loading.value=false;}};const discardChanges=()=>{formDirty.value=false;showUnsavedDialog.value=false;if(pendingNavigation.value){router.push(pendingNavigation.value);}else{router.back();}};router.beforeEach((to,from,next)=>{if(formDirty.value&&from.name===route.name){showUnsavedDialog.value=true;pendingNavigation.value=to.fullPath;next(false);}else{next();}});onMounted(()=>{fetchFitment();});return{router,formRef,isFormValid,initialLoading,loading,formError,errors,form,attributes,associatedProducts,makeOptions,modelOptions,engineOptions,transmissionOptions,showUnsavedDialog,pendingNavigation,isEditMode,rules,clearError,addAttribute,removeAttribute,submitForm,discardChanges};}});</script>