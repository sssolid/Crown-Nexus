<!-- frontend/src/views/MediaLibrary.vue --><template><div><v-container fluid><v-row class="mb-6"><v-col cols="12" md="8"><h1 class="text-h3 font-weight-bold">Media Library</h1><p class="text-subtitle-1">Browse and manage all media assets</p></v-col><v-col cols="12" md="4" class="d-flex justify-end align-center"><v-btn color="primary" prepend-icon="mdi-upload" @click="showUploadDialog=true" > Upload Media </v-btn></v-col></v-row><v-row><v-col cols="12" md="9"><v-card class="mb-6"><v-card-text><v-row><v-col cols="12" md="6"><v-text-field v-model="search" label="Search Media" variant="outlined" density="comfortable" append-inner-icon="mdi-magnify" hide-details @input="applyFilters" clearable ></v-text-field></v-col><v-col cols="12" md="3"><v-select v-model="filters.file_type" label="File Type" :items="fileTypeOptions" variant="outlined" density="comfortable" hide-details @update:modelValue="applyFilters" clearable ></v-select></v-col><v-col cols="12" md="3"><v-select v-model="sortOption" label="Sort By" :items="sortOptions" variant="outlined" density="comfortable" hide-details @update:modelValue="applyFilters" ></v-select></v-col></v-row><v-row class="mt-2"><v-col cols="12" class="d-flex justify-end"><v-btn variant="text" color="primary" @click="showAdvancedFilters=!showAdvancedFilters" ><v-icon :icon="showAdvancedFilters ? 'mdi-chevron-up' : 'mdi-chevron-down'" class="mr-1"></v-icon> Advanced Filters </v-btn><v-btn variant="text" color="secondary" class="ml-2" @click="resetFilters" > Reset Filters </v-btn></v-col></v-row><v-expand-transition><div v-if="showAdvancedFilters"><v-divider class="mt-2 mb-4"></v-divider><v-row><v-col cols="12" md="4"><v-select v-model="filters.product_id" label="Associated Product" :items="productOptions" item-title="name" item-value="id" variant="outlined" density="comfortable" hide-details clearable ></v-select></v-col><v-col cols="12" md="4"><v-menu v-model="dateMenu" :close-on-content-click="false" ><template v-slot:activator="{ props }"><v-text-field v-model="dateRangeText" label="Date Range" variant="outlined" density="comfortable" prepend-inner-icon="mdi-calendar" readonly v-bind="props" hide-details clearable @click:clear="clearDateRange" ></v-text-field></template><v-date-picker v-model="dateRange" range @update:modelValue="dateMenu = false" ></v-date-picker></v-menu></v-col><!-- Size Filter --><v-col cols="12" md="4"><v-select v-model="filters.size" label="File Size" :items="[ { title: 'Small (< 1MB)', value: 'small' }, { title: 'Medium (1-5MB)', value: 'medium' }, { title: 'Large (> 5MB)', value: 'large' } ]" item-title="title" item-value="value" variant="outlined" density="comfortable" hide-details clearable ></v-select></v-col></v-row></div></v-expand-transition></v-card-text><v-divider></v-divider><v-card-actions><div class="d-flex align-center"><v-chip v-if="selected.length > 0" class="mr-2"> {{ selected.length }} selected </v-chip><v-menu v-if="selected.length > 0"><template v-slot:activator="{ props }"><v-btn variant="text" color="primary" v-bind="props" > Batch Actions </v-btn></template><v-list><v-list-item @click="batchAssociateProduct" :disabled="!canAssociateWithProduct" ><template v-slot:prepend><v-icon icon="mdi-link"></v-icon></template><v-list-item-title>Associate with Product</v-list-item-title></v-list-item><v-list-item @click="confirmBatchDelete" :disabled="!canDeleteMedia" ><template v-slot:prepend><v-icon color="error">mdi-delete</v-icon></template><v-list-item-title>Delete Selected</v-list-item-title></v-list-item></v-list></v-menu></div><v-spacer></v-spacer><v-btn-toggle v-model="viewMode" mandatory><v-btn value="grid" icon="mdi-grid"></v-btn><v-btn value="list" icon="mdi-format-list-bulleted"></v-btn></v-btn-toggle></v-card-actions></v-card><!-- Loading State --><div v-if="loading" class="d-flex justify-center my-6"><v-progress-circular indeterminate color="primary" size="64" ></v-progress-circular></div><!-- Media Grid View --><v-card v-else-if="viewMode === 'grid' && filteredMedia.length > 0"><v-row class="pa-2"><v-col v-for="item in filteredMedia" :key="item.id" cols="6" sm="4" md="3" class="pa-2" ><v-card variant="outlined" class="media-item" :class="{ 'media-selected': isSelected(item) }" ><!-- Selection Checkbox --><v-checkbox v-model="selected" :value="item" hide-details class="media-checkbox pa-2" @click.stop ></v-checkbox><!-- Media Thumbnail --><div class="media-thumbnail-container" @click="toggleSelect(item)" ><v-img v-if="isImage(item)" :src="item.url" height="150" cover class="media-thumbnail" @dblclick="openMediaPreview(item)" ></v-img><div v-else class="d-flex align-center justify-center non-image-thumbnail" style="height: 150px;" @dblclick="openMediaPreview(item)" ><v-icon :icon="getFileTypeIcon(item)" size="x-large" color="primary" ></v-icon></div></div><v-divider></v-divider><v-card-title class="px-3 py-2 d-flex justify-space-between text-subtitle-2"><span class="text-truncate">{{ item.filename }}</span><v-menu location="bottom"><template v-slot:activator="{ props }"><v-btn icon="mdi-dots-vertical" size="small" variant="text" v-bind="props" @click.stop ></v-btn></template><v-list><v-list-item @click="openMediaPreview(item)"><template v-slot:prepend><v-icon icon="mdi-eye"></v-icon></template><v-list-item-title>Preview</v-list-item-title></v-list-item><v-list-item @click="editMedia(item)"><template v-slot:prepend><v-icon icon="mdi-pencil"></v-icon></template><v-list-item-title>Edit</v-list-item-title></v-list-item><v-list-item @click="downloadMedia(item)"><template v-slot:prepend><v-icon icon="mdi-download"></v-icon></template><v-list-item-title>Download</v-list-item-title></v-list-item><v-divider></v-divider><v-list-item @click="associateWithProduct(item)" :disabled="!canAssociateWithProduct" ><template v-slot:prepend><v-icon icon="mdi-link"></v-icon></template><v-list-item-title>Associate with Product</v-list-item-title></v-list-item><v-list-item @click="confirmDeleteMedia(item)" :disabled="!canDeleteMedia" ><template v-slot:prepend><v-icon color="error">mdi-delete</v-icon></template><v-list-item-title>Delete</v-list-item-title></v-list-item></v-list></v-menu></v-card-title><v-card-subtitle class="px-3 pt-0 pb-2"><div class="d-flex justify-space-between"><span class="text-caption">{{ formatFileSize(item.size) }}</span><span class="text-caption">{{ formatDate(item.created_at) }}</span></div></v-card-subtitle></v-card></v-col></v-row><!-- Pagination --><v-card-actions><v-spacer></v-spacer><v-pagination v-model="page" :length="totalPages" @update:modelValue="fetchMedia" rounded="circle" ></v-pagination><v-spacer></v-spacer></v-card-actions></v-card><!-- Media List View --><v-card v-else-if="viewMode === 'list' && filteredMedia.length > 0"><v-data-table v-model="selected" :headers="headers" :items="filteredMedia" item-value="id" show-select ><!-- Filename Column --><template v-slot:item.filename="{ item }"><div class="d-flex align-center"><v-avatar size="36" color="grey-lighten-4" class="mr-2"><v-icon :icon="getFileTypeIcon(item.raw)"></v-icon></v-avatar><div><div class="font-weight-medium">{{ item.raw.filename }}</div><div class="text-caption">{{ getFileTypeLabel(item.raw) }}</div></div></div></template><!-- Size Column --><template v-slot:item.size="{ item }"> {{ formatFileSize(item.raw.size) }} </template><!-- Date Column --><template v-slot:item.created_at="{ item }"> {{ formatDate(item.raw.created_at) }} </template><!-- Product Column --><template v-slot:item.product="{ item }"><v-chip v-if="item.raw.product" size="small" color="primary" variant="tonal" :to="{ name: 'ProductDetail', params: { id: item.raw.product.id } }" > {{ item.raw.product.name }} </v-chip><span v-else class="text-medium-emphasis">None</span></template><!-- Actions Column --><template v-slot:item.actions="{ item }"><v-tooltip text="Preview"><template v-slot:activator="{ props }"><v-btn icon size="small" v-bind="props" @click="openMediaPreview(item.raw)" ><v-icon>mdi-eye</v-icon></v-btn></template></v-tooltip><v-tooltip text="Edit"><template v-slot:activator="{ props }"><v-btn icon size="small" color="info" v-bind="props" @click="editMedia(item.raw)" class="ml-1" ><v-icon>mdi-pencil</v-icon></v-btn></template></v-tooltip><v-tooltip text="Download"><template v-slot:activator="{ props }"><v-btn icon size="small" color="success" v-bind="props" @click="downloadMedia(item.raw)" class="ml-1" ><v-icon>mdi-download</v-icon></v-btn></template></v-tooltip><v-tooltip text="Delete"><template v-slot:activator="{ props }"><v-btn icon size="small" color="error" v-bind="props" @click="confirmDeleteMedia(item.raw)" class="ml-1" :disabled="!canDeleteMedia" ><v-icon>mdi-delete</v-icon></v-btn></template></v-tooltip></template></v-data-table><!-- Pagination --><v-card-actions><v-spacer></v-spacer><v-pagination v-model="page" :length="totalPages" @update:modelValue="fetchMedia" rounded="circle" ></v-pagination><v-spacer></v-spacer></v-card-actions></v-card><!-- No Results --><v-card v-else-if="!loading"><v-card-text class="text-center py-8"><v-icon icon="mdi-image-off" size="x-large" class="mb-4"></v-icon><h3 class="text-h6 mb-2">No Media Found</h3><p class="mb-4">{{ search || Object.keys(filters).some(k => filters[k]) ? 'No media matches your search criteria.' : 'The media library is empty.' }}</p><v-btn color="primary" prepend-icon="mdi-upload" @click="showUploadDialog = true" > Upload Media </v-btn></v-card-text></v-card></v-col><!-- Sidebar --><v-col cols="12" md="3"><!-- Media Statistics --><v-card class="mb-6"><v-card-title> Media Statistics </v-card-title><v-divider></v-divider><v-list density="compact"><v-list-item><template v-slot:prepend><v-avatar color="primary" variant="tonal"><v-icon>mdi-image-multiple</v-icon></v-avatar></template><v-list-item-title>Total Media</v-list-item-title><v-list-item-subtitle>{{ totalMediaCount }}</v-list-item-subtitle></v-list-item><v-list-item><template v-slot:prepend><v-avatar color="info" variant="tonal"><v-icon>mdi-image</v-icon></v-avatar></template><v-list-item-title>Images</v-list-item-title><v-list-item-subtitle>{{ imageCount }}</v-list-item-subtitle></v-list-item><v-list-item><template v-slot:prepend><v-avatar color="success" variant="tonal"><v-icon>mdi-file-document</v-icon></v-avatar></template><v-list-item-title>Documents</v-list-item-title><v-list-item-subtitle>{{ documentCount }}</v-list-item-subtitle></v-list-item><v-list-item><template v-slot:prepend><v-avatar color="warning" variant="tonal"><v-icon>mdi-harddisk</v-icon></v-avatar></template><v-list-item-title>Total Size</v-list-item-title><v-list-item-subtitle>{{ formatFileSize(totalSize) }}</v-list-item-subtitle></v-list-item></v-list></v-card><!-- Quick Actions --><v-card class="mb-6"><v-card-title> Quick Actions </v-card-title><v-divider></v-divider><v-card-text><v-row><v-col cols="12"><v-btn block color="primary" variant="outlined" prepend-icon="mdi-upload" @click="showUploadDialog = true" > Upload Media </v-btn></v-col><v-col cols="12"><v-btn block color="secondary" variant="outlined" prepend-icon="mdi-download-multiple" @click="bulkDownload" :disabled="selected.length === 0" > Download Selected </v-btn></v-col><v-col cols="12"><v-btn block color="secondary" variant="outlined" prepend-icon="mdi-search" @click="showAdvancedFilters = true" > Advanced Search </v-btn></v-col></v-row></v-card-text></v-card><!-- Recently Uploaded --><v-card v-if="recentUploads.length > 0"><v-card-title> Recently Uploaded </v-card-title><v-divider></v-divider><v-list lines="two"><v-list-item v-for="item in recentUploads" :key="item.id" @click="openMediaPreview(item)" ><template v-slot:prepend><v-avatar size="40"><v-img v-if="isImage(item)" :src="item.url" cover ></v-img><v-icon v-else :icon="getFileTypeIcon(item)"></v-icon></v-avatar></template><v-list-item-title>{{ item.filename }}</v-list-item-title><v-list-item-subtitle><span>{{ formatFileSize(item.size) }}</span><span class="mx-1">•</span><span>{{ formatTimeAgo(item.created_at) }}</span></v-list-item-subtitle></v-list-item></v-list></v-card></v-col></v-row><!-- Upload Dialog --><v-dialog v-model="showUploadDialog" max-width="800" persistent><v-card><v-card-title class="text-h5 pa-4"> Upload Media </v-card-title><v-divider></v-divider><v-card-text class="pa-4"><p class="mb-4"> Upload images or documents to the media library. Allowed file types: JPG, PNG, GIF, SVG, PDF, DOCX. </p><!-- Drag and Drop Upload Area --><v-card :variant="isDragging ? 'flat' : 'outlined'" :color="isDragging ? 'primary' : undefined" class="upload-dropzone pa-6 mb-4" @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop.prevent="handleFileDrop" @click="$refs.fileInput.click()" ><input ref="fileInput" type="file" @change="handleFileSelect" multiple accept=".jpg,.jpeg,.png,.gif,.svg,.pdf,.docx" style="display: none" /><div class="text-center"><v-icon :icon="isDragging ? 'mdi-cloud-upload' : 'mdi-file-upload'" size="64" :color="isDragging ? 'white' : 'primary'" class="mb-4" ></v-icon><h3 class="text-h6 mb-2"> {{ isDragging ? 'Drop files here' : 'Click or drag files here to upload' }} </h3><p class="text-caption text-medium-emphasis" v-if="!isDragging"> Maximum file size: 10MB </p></div></v-card><!-- Product Association --><v-select v-model="uploadForm.product_id" label="Associate with Product (Optional)" variant="outlined" :items="productOptions" item-title="name" item-value="id" clearable class="mb-4" ></v-select><!-- Selected Files List --><div v-if="filesToUpload.length > 0"><p class="text-subtitle-1 mb-2">Selected Files:</p><v-list lines="two"><v-list-item v-for="(file, index) in filesToUpload" :key="index" ><template v-slot:prepend><v-avatar size="40" color="grey-lighten-3"><v-icon :icon="getFileIcon(file)"></v-icon></v-avatar></template><v-list-item-title>{{ file.name }}</v-list-item-title><v-list-item-subtitle> {{ formatFileSize(file.size) }} </v-list-item-subtitle><template v-slot:append><v-btn icon size="small" color="error" variant="text" @click="removeFileFromUpload(index)" ><v-icon>mdi-close</v-icon></v-btn></template></v-list-item></v-list></div><!-- Upload Progress --><div v-if="uploading"><v-progress-linear v-model="uploadProgress" color="primary" height="10" striped class="mt-4" ></v-progress-linear><div class="d-flex justify-space-between mt-2"><span class="text-caption">Uploading...</span><span class="text-caption">{{ uploadProgress.toFixed(0) }}%</span></div></div></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn color="secondary" variant="tonal" @click="cancelUpload" :disabled="uploading" > Cancel </v-btn><v-btn color="primary" @click="uploadFiles" :loading="uploading" :disabled="filesToUpload.length === 0" > Upload Files </v-btn></v-card-actions></v-card></v-dialog><!-- Media Preview Dialog --><v-dialog v-model="showPreviewDialog" max-width="800"><v-card><v-card-title class="d-flex justify-space-between align-center pa-4"><span class="text-truncate">{{ selectedMedia?.filename || 'Media Preview' }}</span><v-btn icon @click="showPreviewDialog = false"><v-icon>mdi-close</v-icon></v-btn></v-card-title><v-divider></v-divider><v-card-text class="pa-0"><v-img v-if="selectedMedia && isImage(selectedMedia)" :src="selectedMedia.url" height="500" contain class="mx-auto" ></v-img><div v-else-if="selectedMedia && !isImage(selectedMedia)" class="d-flex flex-column align-center justify-center pa-6" style="height: 300px" ><v-icon :icon="getFileTypeIcon(selectedMedia)" size="x-large" color="primary" class="mb-4"></v-icon><p class="text-h6">{{ selectedMedia.filename }}</p><p class="text-caption">{{ formatFileSize(selectedMedia.size) }}</p><v-btn color="primary" variant="tonal" prepend-icon="mdi-download" class="mt-4" :href="selectedMedia.url" target="_blank" > Download </v-btn></div></v-card-text><v-divider></v-divider><v-card-text class="pa-4"><v-list density="compact"><v-list-item><v-list-item-title>File Type</v-list-item-title><v-list-item-subtitle>{{ selectedMedia ? getFileTypeLabel(selectedMedia) : '' }}</v-list-item-subtitle></v-list-item><v-list-item><v-list-item-title>Size</v-list-item-title><v-list-item-subtitle>{{ selectedMedia ? formatFileSize(selectedMedia.size) : '' }}</v-list-item-subtitle></v-list-item><v-list-item><v-list-item-title>Uploaded</v-list-item-title><v-list-item-subtitle>{{ selectedMedia ? formatDateTime(selectedMedia.created_at) : '' }}</v-list-item-subtitle></v-list-item><v-list-item v-if="selectedMedia?.product"><v-list-item-title>Associated Product</v-list-item-title><v-list-item-subtitle><v-chip size="small" color="primary" variant="tonal" :to="{ name: 'ProductDetail', params: { id: selectedMedia.product.id } }" > {{ selectedMedia.product.name }} </v-chip></v-list-item-subtitle></v-list-item><v-list-item v-if="selectedMedia?.description"><v-list-item-title>Description</v-list-item-title><v-list-item-subtitle>{{ selectedMedia.description }}</v-list-item-subtitle></v-list-item></v-list></v-card-text><v-divider></v-divider><v-card-actions class="pa-4"><v-btn color="primary" variant="tonal" prepend-icon="mdi-pencil" @click="editFromPreview" > Edit </v-btn><v-spacer></v-spacer><v-btn color="secondary" variant="tonal" prepend-icon="mdi-download" @click="downloadMedia(selectedMedia)" > Download </v-btn><v-btn v-if="canDeleteMedia" color="error" variant="tonal" prepend-icon="mdi-delete" @click="confirmDeleteFromPreview" > Delete </v-btn></v-card-actions></v-card></v-dialog><!-- Edit Media Dialog --><v-dialog v-model="showEditDialog" max-width="600"><v-card><v-card-title class="text-h5 pa-4"> Edit Media Details </v-card-title><v-divider></v-divider><v-card-text class="pa-4"><v-form ref="editForm" v-model="isEditFormValid"><v-text-field v-model="editForm.filename" label="Filename" variant="outlined" :rules="[rules.required]" class="mb-4" ></v-text-field><v-text-field v-model="editForm.alt_text" label="Alt Text" variant="outlined" hint="Text description for accessibility" persistent-hint class="mb-4" ></v-text-field><v-textarea v-model="editForm.description" label="Description" variant="outlined" rows="3" auto-grow class="mb-4" ></v-textarea><v-select v-model="editForm.product_id" label="Associated Product" variant="outlined" :items="productOptions" item-title="name" item-value="id" clearable ></v-select></v-form></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn color="secondary" variant="tonal" @click="showEditDialog = false" > Cancel </v-btn><v-btn color="primary" @click="saveMediaEdit" :loading="editLoading" :disabled="!isEditFormValid" > Save Changes </v-btn></v-card-actions></v-card></v-dialog><!-- Delete Confirmation Dialog --><v-dialog v-model="showDeleteDialog" max-width="500"><v-card><v-card-title class="text-h5 bg-error text-white pa-4"> Delete Media </v-card-title><v-card-text class="pa-4 pt-6"><p> Are you sure you want to delete the media file <strong>{{ mediaToDelete?.filename }}</strong>? </p><p class="text-medium-emphasis mt-2"> This action cannot be undone. The file will be permanently removed from the server. </p><v-alert v-if="mediaToDelete?.product" type="warning" variant="tonal" class="mt-4" > This media is associated with product "{{ mediaToDelete.product.name }}". Deleting it may affect product displays. </v-alert></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn color="secondary" variant="tonal" @click="showDeleteDialog = false" > Cancel </v-btn><v-btn color="error" @click="deleteMedia" :loading="deleteLoading" > Delete </v-btn></v-card-actions></v-card></v-dialog><!-- Batch Delete Dialog --><v-dialog v-model="showBatchDeleteDialog" max-width="500"><v-card><v-card-title class="text-h5 bg-error text-white pa-4"> Delete Multiple Media </v-card-title><v-card-text class="pa-4 pt-6"><p> Are you sure you want to delete <strong>{{ selected.length }}</strong> media files? </p><p class="text-medium-emphasis mt-2"> This action cannot be undone. The files will be permanently removed from the server. </p><v-alert v-if="hasSelectedWithProducts" type="warning" variant="tonal" class="mt-4" > Some of these files are associated with products. Deleting them may affect product displays. </v-alert></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn color="secondary" variant="tonal" @click="showBatchDeleteDialog = false" > Cancel </v-btn><v-btn color="error" @click="batchDeleteMedia" :loading="batchDeleteLoading" > Delete Selected </v-btn></v-card-actions></v-card></v-dialog><!-- Associate with Product Dialog --><v-dialog v-model="showAssociateDialog" max-width="600"><v-card><v-card-title class="text-h5 pa-4"> Associate with Product </v-card-title><v-divider></v-divider><v-card-text class="pa-4"><p class="mb-4"> Select a product to associate with {{ mediaToAssociate ? 'this media file' : `${selected.length} selected files` }}. </p><v-select v-model="associateForm.product_id" label="Product" variant="outlined" :items="productOptions" item-title="name" item-value="id" :rules="[rules.required]" required ></v-select></v-card-text><v-card-actions class="pa-4"><v-spacer></v-spacer><v-btn color="secondary" variant="tonal" @click="showAssociateDialog = false" > Cancel </v-btn><v-btn color="primary" @click="confirmAssociate" :loading="associateLoading" :disabled="!associateForm.product_id" > Associate </v-btn></v-card-actions></v-card></v-dialog></v-container></div></template><script lang="ts">import{defineComponent,ref,computed,onMounted,watch}from 'vue';import{useRouter}from 'vue-router';import{useAuthStore}from '@/stores/auth';import mediaService from '@/services/media';import productService from '@/services/product';import{Media,MediaMetadata}from '@/types/media';import{Product}from '@/types/product';import{formatDate,formatDateTime,formatFileSize}from '@/utils/formatters';import{notificationService}from '@/utils/notification';export default defineComponent({name:'MediaLibrary',setup(){const router=useRouter();const authStore=useAuthStore();const fileInput=ref<HTMLInputElement|null>(null);const editForm=ref<HTMLFormElement|null>(null);const loading=ref(true);const uploading=ref(false);const editLoading=ref(false);const deleteLoading=ref(false);const batchDeleteLoading=ref(false);const associateLoading=ref(false);const allMedia=ref<Media[]>([]);const filteredMedia=ref<Media[]>([]);const selected=ref<Media[]>([]);const recentUploads=ref<Media[]>([]);const showUploadDialog=ref(false);const showPreviewDialog=ref(false);const showEditDialog=ref(false);const showDeleteDialog=ref(false);const showBatchDeleteDialog=ref(false);const showAssociateDialog=ref(false);const selectedMedia=ref<Media|null>(null);const mediaToDelete=ref<Media|null>(null);const mediaToAssociate=ref<Media|null>(null);const viewMode=ref<'grid'|'list'>('grid');const page=ref(1);const pageSize=ref(20);const totalPages=ref(1);const search=ref('');const showAdvancedFilters=ref(false);const filters=ref<Record<string,any>>({});const sortOption=ref('newest');const dateRange=ref<string[]>([]);const dateMenu=ref(false);const isDragging=ref(false);const filesToUpload=ref<File[]>([]);const uploadProgress=ref(0);const uploadForm=ref({product_id:null as string|null});const isEditFormValid=ref(true);const editForm=ref({filename:'',alt_text:'',description:'',product_id:null as string|null});const associateForm=ref({product_id:null as string|null});const productOptions=ref<{id:string;name:string}[]>([]);const fileTypeOptions=ref([{title:'All Files',value:'all'},{title:'Images',value:'image'},{title:'Documents',value:'document'}]);const sortOptions=ref([{title:'Newest First',value:'newest'},{title:'Oldest First',value:'oldest'},{title:'Name A-Z',value:'name_asc'},{title:'Name Z-A',value:'name_desc'},{title:'Size (Largest)',value:'size_desc'},{title:'Size (Smallest)',value:'size_asc'}]);const headers=ref([{title:'Filename',key:'filename',sortable:true},{title:'Type',key:'file_type',sortable:true},{title:'Size',key:'size',sortable:true},{title:'Uploaded',key:'created_at',sortable:true},{title:'Product',key:'product',sortable:false},{title:'Actions',key:'actions',sortable:false,align:'end'}]);const rules={required:(v:string)=>!!v||'This field is required'};const canDeleteMedia=computed(()=>{return authStore.isAdmin;});const canAssociateWithProduct=computed(()=>{return authStore.isAdmin;});const hasSelectedWithProducts=computed(()=>{return selected.value.some(media=>media.product);});const dateRangeText=computed(()=>{if(!dateRange.value||dateRange.value.length!==2)return '';return `${dateRange.value[0]} to ${dateRange.value[1]}`;});const totalMediaCount=computed(()=>{return allMedia.value.length;});const imageCount=computed(()=>{return allMedia.value.filter(item=>isImage(item)).length;});const documentCount=computed(()=>{return allMedia.value.filter(item=>!isImage(item)).length;});const totalSize=computed(()=>{return allMedia.value.reduce((sum,item)=>sum+item.size,0);});const isImage=(media:Media):boolean=>{const imageTypes=['image/jpeg','image/png','image/gif','image/svg+xml'];return imageTypes.includes(media.file_type);};const getFileTypeLabel=(media:Media):string=>{switch(media.file_type){case 'image/jpeg':return 'JPEG Image';case 'image/png':return 'PNG Image';case 'image/gif':return 'GIF Image';case 'image/svg+xml':return 'SVG Image';case 'application/pdf':return 'PDF Document';case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':return 'Word Document';default:return media.file_type;}};const getFileTypeIcon=(media:Media):string=>{if(isImage(media)){return 'mdi-file-image';}else if(media.file_type==='application/pdf'){return 'mdi-file-pdf';}else if(media.file_type.includes('document')){return 'mdi-file-document';}else{return 'mdi-file';}};const getFileIcon=(file:File):string=>{if(file.type.startsWith('image/')){return 'mdi-file-image';}else if(file.type==='application/pdf'){return 'mdi-file-pdf';}else if(file.type.includes('document')){return 'mdi-file-document';}else{return 'mdi-file';}};const formatTimeAgo=(dateString:string):string=>{const date=new Date(dateString);const now=new Date();const diffMs=now.getTime()-date.getTime();const diffSecs=Math.floor(diffMs/1000);const diffMins=Math.floor(diffSecs/60);const diffHours=Math.floor(diffMins/60);const diffDays=Math.floor(diffHours/24);if(diffSecs<60){return 'Just now';}else if(diffMins<60){return `${diffMins} ${diffMins === 1 ? __STRING_81__ : __STRING_82__} ago`;}else if(diffHours<24){return `${diffHours} ${diffHours === 1 ? __STRING_83__ : __STRING_84__} ago`;}else if(diffDays<7){return `${diffDays} ${diffDays === 1 ? __STRING_85__ : __STRING_86__} ago`;}else{return formatDate(dateString);}};const toggleSelect=(media:Media)=>{const index=selected.value.findIndex(item=>item.id===media.id);if(index===-1){selected.value.push(media);}else{selected.value.splice(index,1);}};const isSelected=(media:Media):boolean=>{return selected.value.some(item=>item.id===media.id);};const fetchMedia=async(applyClientFilters:boolean=true)=>{loading.value=true;try{const apiFilters={...filters.value,page:page.value,page_size:pageSize.value,search:search.value||undefined};if(dateRange.value&&dateRange.value.length===2){apiFilters.date_from=dateRange.value[0];apiFilters.date_to=dateRange.value[1];}const response=await mediaService.getMediaList(apiFilters);allMedia.value=response.items;totalPages.value=response.pages;if(applyClientFilters){applyClientSideFilters();}else{filteredMedia.value=[...allMedia.value];}fetchRecentUploads();}catch(error){console.error('Error fetching media:',error);notificationService.error('Failed to load media');filteredMedia.value=[];}finally{loading.value=false;}};const applyClientSideFilters=()=>{let result=[...allMedia.value];if(search.value&&!filters.value.search){const searchLower=search.value.toLowerCase();result=result.filter(item=>item.filename.toLowerCase().includes(searchLower)||(item.description&&item.description.toLowerCase().includes(searchLower)));}if(filters.value.file_type&&filters.value.file_type!=='all'){if(filters.value.file_type==='image'){result=result.filter(item=>isImage(item));}else if(filters.value.file_type==='document'){result=result.filter(item=>!isImage(item));}}if(filters.value.size){if(filters.value.size==='small'){result=result.filter(item=>item.size<1024*1024);}else if(filters.value.size==='medium'){result=result.filter(item=>item.size>=1024*1024&&item.size<=5*1024*1024);}else if(filters.value.size==='large'){result=result.filter(item=>item.size>5*1024*1024);}}if(sortOption.value){if(sortOption.value==='newest'){result.sort((a,b)=>new Date(b.created_at).getTime()-new Date(a.created_at).getTime());}else if(sortOption.value==='oldest'){result.sort((a,b)=>new Date(a.created_at).getTime()-new Date(b.created_at).getTime());}else if(sortOption.value==='name_asc'){result.sort((a,b)=>a.filename.localeCompare(b.filename));}else if(sortOption.value==='name_desc'){result.sort((a,b)=>b.filename.localeCompare(a.filename));}else if(sortOption.value==='size_desc'){result.sort((a,b)=>b.size-a.size);}else if(sortOption.value==='size_asc'){result.sort((a,b)=>a.size-b.size);}}filteredMedia.value=result;};const applyFilters=()=>{if(Object.keys(filters.value).some(key=>!!filters.value[key])||search.value){fetchMedia(true);}else{applyClientSideFilters();}};const resetFilters=()=>{search.value='';filters.value={};dateRange.value=[];sortOption.value='newest';page.value=1;fetchMedia();};const clearDateRange=()=>{dateRange.value=[];applyFilters();};const fetchRecentUploads=async()=>{try{const sorted=[...allMedia.value].sort((a,b)=>new Date(b.created_at).getTime()-new Date(a.created_at).getTime());recentUploads.value=sorted.slice(0,5);}catch(error){console.error('Error fetching recent uploads:',error);recentUploads.value=[];}};const fetchProductOptions=async()=>{try{const response=await productService.getProducts({page_size:100});productOptions.value=response.items.map(product=>({id:product.id,name:`${product.sku} - ${product.name}`}));}catch(error){console.error('Error fetching product options:',error);productOptions.value=[];}};const openMediaPreview=(media:Media)=>{selectedMedia.value=media;showPreviewDialog.value=true;};const downloadMedia=(media:Media|null)=>{if(!media)return;const link=document.createElement('a');link.href=media.url;link.download=media.filename;document.body.appendChild(link);link.click();document.body.removeChild(link);};const bulkDownload=()=>{if(selected.value.length===0)return;selected.value.forEach(media=>{downloadMedia(media);});notificationService.success(`Downloading ${selected.value.length} files`);};const editMedia=(media:Media)=>{selectedMedia.value=media;editForm.value={filename:media.filename,alt_text:media.alt_text||'',description:media.description||'',product_id:media.product?.id||null};showEditDialog.value=true;if(showPreviewDialog.value){showPreviewDialog.value=false;}};const editFromPreview=()=>{if(!selectedMedia.value)return;editMedia(selectedMedia.value);};const saveMediaEdit=async()=>{if(!selectedMedia.value)return;editLoading.value=true;try{const updatedMedia=await mediaService.updateMedia(selectedMedia.value.id,{filename:editForm.value.filename,alt_text:editForm.value.alt_text,description:editForm.value.description,product_id:editForm.value.product_id});const index=allMedia.value.findIndex(m=>m.id===selectedMedia.value?.id);if(index!==-1){allMedia.value[index]=updatedMedia;}const filteredIndex=filteredMedia.value.findIndex(m=>m.id===selectedMedia.value?.id);if(filteredIndex!==-1){filteredMedia.value[filteredIndex]=updatedMedia;}selectedMedia.value=updatedMedia;showEditDialog.value=false;notificationService.success('Media details updated successfully');}catch(error){console.error('Error updating media:',error);notificationService.error('Failed to update media details');}finally{editLoading.value=false;}};const confirmDeleteMedia=(media:Media)=>{mediaToDelete.value=media;showDeleteDialog.value=true;};const confirmDeleteFromPreview=()=>{if(!selectedMedia.value)return;mediaToDelete.value=selectedMedia.value;showDeleteDialog.value=true;showPreviewDialog.value=false;};const deleteMedia=async()=>{if(!mediaToDelete.value)return;deleteLoading.value=true;try{await mediaService.deleteMedia(mediaToDelete.value.id);allMedia.value=allMedia.value.filter(m=>m.id!==mediaToDelete.value?.id);filteredMedia.value=filteredMedia.value.filter(m=>m.id!==mediaToDelete.value?.id);selected.value=selected.value.filter(m=>m.id!==mediaToDelete.value?.id);recentUploads.value=recentUploads.value.filter(m=>m.id!==mediaToDelete.value?.id);showDeleteDialog.value=false;if(selectedMedia.value?.id===mediaToDelete.value.id){showPreviewDialog.value=false;selectedMedia.value=null;}mediaToDelete.value=null;notificationService.success('Media deleted successfully');}catch(error){console.error('Error deleting media:',error);notificationService.error('Failed to delete media');}finally{deleteLoading.value=false;}};const confirmBatchDelete=()=>{if(selected.value.length===0)return;showBatchDeleteDialog.value=true;};const batchDeleteMedia=async()=>{if(selected.value.length===0)return;batchDeleteLoading.value=true;try{const deletePromises=selected.value.map(media=>mediaService.deleteMedia(media.id));await Promise.all(deletePromises);const deletedIds=selected.value.map(m=>m.id);allMedia.value=allMedia.value.filter(m=>!deletedIds.includes(m.id));filteredMedia.value=filteredMedia.value.filter(m=>!deletedIds.includes(m.id));recentUploads.value=recentUploads.value.filter(m=>!deletedIds.includes(m.id));selected.value=[];showBatchDeleteDialog.value=false;notificationService.success(`${deletedIds.length} media files deleted successfully`);}catch(error){console.error('Error batch deleting media:',error);notificationService.error('Failed to delete selected media');}finally{batchDeleteLoading.value=false;}};const associateWithProduct=(media:Media)=>{mediaToAssociate.value=media;associateForm.value.product_id=media.product?.id||null;showAssociateDialog.value=true;};const batchAssociateProduct=()=>{if(selected.value.length===0)return;mediaToAssociate.value=null;associateForm.value.product_id=null;showAssociateDialog.value=true;};const confirmAssociate=async()=>{if(!associateForm.value.product_id)return;associateLoading.value=true;try{if(mediaToAssociate.value){const updatedMedia=await mediaService.associateMediaWithProduct(mediaToAssociate.value.id,associateForm.value.product_id);const index=allMedia.value.findIndex(m=>m.id===mediaToAssociate.value?.id);if(index!==-1){allMedia.value[index]=updatedMedia;}const filteredIndex=filteredMedia.value.findIndex(m=>m.id===mediaToAssociate.value?.id);if(filteredIndex!==-1){filteredMedia.value[filteredIndex]=updatedMedia;}notificationService.success('Media associated with product successfully');}else{const associatePromises=selected.value.map(media=>mediaService.associateMediaWithProduct(media.id,associateForm.value.product_id as string));const updatedMedia=await Promise.all(associatePromises);updatedMedia.forEach(media=>{const index=allMedia.value.findIndex(m=>m.id===media.id);if(index!==-1){allMedia.value[index]=media;}const filteredIndex=filteredMedia.value.findIndex(m=>m.id===media.id);if(filteredIndex!==-1){filteredMedia.value[filteredIndex]=media;}});notificationService.success(`${updatedMedia.length} media files associated with product successfully`);}showAssociateDialog.value=false;mediaToAssociate.value=null;}catch(error){console.error('Error associating media with product:',error);notificationService.error('Failed to associate media with product');}finally{associateLoading.value=false;}};const handleFileSelect=(event:Event)=>{const input=event.target as HTMLInputElement;if(input.files){for(let i=0;i<input.files.length;i++){addFileToUpload(input.files[i]);}}};const handleFileDrop=(event:DragEvent)=>{isDragging.value=false;if(event.dataTransfer?.files){for(let i=0;i<event.dataTransfer.files.length;i++){addFileToUpload(event.dataTransfer.files[i]);}}};const addFileToUpload=(file:File)=>{if(file.size>10*1024*1024){notificationService.error(`File ${file.name} exceeds the 10MB size limit`);return;}if(filesToUpload.value.some(f=>f.name===file.name&&f.size===file.size)){notificationService.warning(`File ${file.name} is already selected`);return;}filesToUpload.value.push(file);};const removeFileFromUpload=(index:number)=>{filesToUpload.value.splice(index,1);};const cancelUpload=()=>{if(uploading.value)return;filesToUpload.value=[];uploadProgress.value=0;uploadForm.value.product_id=null;showUploadDialog.value=false;};const uploadFiles=async()=>{if(filesToUpload.value.length===0)return;uploading.value=true;uploadProgress.value=0;try{const totalFiles=filesToUpload.value.length;const progressIncrement=100/totalFiles;for(let i=0;i<filesToUpload.value.length;i++){await mediaService.uploadMedia(filesToUpload.value[i],uploadForm.value.product_id);uploadProgress.value+=progressIncrement;}await fetchMedia();filesToUpload.value=[];uploadProgress.value=100;setTimeout(()=>{showUploadDialog.value=false;uploading.value=false;uploadProgress.value=0;uploadForm.value.product_id=null;},1000);notificationService.success(`${totalFiles} file(s) uploaded successfully`);}catch(error){console.error('Error uploading files:',error);notificationService.error('Failed to upload files');uploading.value=false;}};watch(dateRange,(newRange)=>{if(newRange&&newRange.length===2){applyFilters();}});onMounted(async()=>{await fetchProductOptions();await fetchMedia();});return{fileInput,editForm,loading,uploading,editLoading,deleteLoading,batchDeleteLoading,associateLoading,allMedia,filteredMedia,selected,recentUploads,showUploadDialog,showPreviewDialog,showEditDialog,showDeleteDialog,showBatchDeleteDialog,showAssociateDialog,selectedMedia,mediaToDelete,mediaToAssociate,viewMode,page,pageSize,totalPages,search,showAdvancedFilters,filters,sortOption,dateRange,dateMenu,dateRangeText,isDragging,filesToUpload,uploadProgress,uploadForm,isEditFormValid,editForm,associateForm,productOptions,fileTypeOptions,sortOptions,headers,rules,canDeleteMedia,canAssociateWithProduct,hasSelectedWithProducts,totalMediaCount,imageCount,documentCount,totalSize,formatDate,formatDateTime,formatFileSize,formatTimeAgo,isImage,getFileTypeLabel,getFileTypeIcon,getFileIcon,toggleSelect,isSelected,fetchMedia,applyFilters,resetFilters,clearDateRange,openMediaPreview,downloadMedia,bulkDownload,editMedia,editFromPreview,saveMediaEdit,confirmDeleteMedia,confirmDeleteFromPreview,deleteMedia,confirmBatchDelete,batchDeleteMedia,associateWithProduct,batchAssociateProduct,confirmAssociate,handleFileSelect,handleFileDrop,removeFileFromUpload,cancelUpload,uploadFiles};}});</script><style scoped>.media-item{transition:all 0.2s ease;position:relative;overflow:hidden}.media-item:hover{transform:translateY(-4px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}.media-selected{border:2px solid var(--v-primary-base)}.media-checkbox{position:absolute;top:0;left:0;z-index:1}.media-thumbnail-container{cursor:pointer}.non-image-thumbnail{background-color:#f5f5f5}.upload-dropzone{border:2px dashed #ccc;border-radius:8px;transition:all 0.2s ease;cursor:pointer}.upload-dropzone:hover{border-color:var(--v-primary-base)}</style>